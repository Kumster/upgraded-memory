<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Kitchen Compass AI - Multi-Agent System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Elegant Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700;800&family=Source+Sans+3:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- ArcGIS CSS for Heatmap -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <style>
        /* ========== ROOT VARIABLES - WARM PALETTE FROM PRESENTATION ========== */
        :root {
            /* Primary Colors from Presentation */
            --primary: #722F37;           /* Deep burgundy/maroon - title color */
            --primary-dark: #5C262D;
            --primary-light: #8B3A44;
            --primary-glow: rgba(114, 47, 55, 0.25);
            
            /* Accent - Terracotta/Rust Orange */
            --accent: #C75B39;
            --accent-dark: #A84A2D;
            --accent-light: #D97B5D;
            --accent-glow: rgba(199, 91, 57, 0.25);
            
            /* Background - Warm Peachy Blush */
            --bg-primary: #F5DDD5;
            --bg-secondary: #FAEAE5;
            --bg-tertiary: #FFF5F2;
            --bg-card: #FFFFFF;
            
            /* Text Colors */
            --text-primary: #4A2C2A;
            --text-secondary: #6B4744;
            --text-muted: #8B6B68;
            --text-light: #A88B88;
            
            /* Semantic Colors */
            --success: #2D8B5A;
            --success-light: #D4EDDA;
            --warning: #C78C3C;
            --warning-light: #FFF3CD;
            --error: #C75050;
            --error-light: #F8D7DA;
            --info: #4A7C9B;
            --info-light: #D1ECF1;
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(74, 44, 42, 0.08);
            --shadow-md: 0 8px 25px rgba(74, 44, 42, 0.1);
            --shadow-lg: 0 15px 40px rgba(74, 44, 42, 0.12);
            
            /* Borders */
            --border-light: rgba(114, 47, 55, 0.1);
            --border-medium: rgba(114, 47, 55, 0.2);
        }

        /* ========== GLOBAL STYLES ========== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100vh;
            overflow: hidden;
            font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            position: relative;
        }

        /* Subtle Pattern Overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(199, 91, 57, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(114, 47, 55, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* ========== MAIN CONTAINER ========== */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            padding: 1rem;
            gap: 1rem;
            position: relative;
            z-index: 1;
        }

        /* ========== SIDEBAR - WARM ELEGANT STYLE ========== */
        .sidebar {
            width: 300px;
            min-width: 300px;
            height: calc(100vh - 2rem);
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            flex-shrink: 0;
        }

        .sidebar.closed {
            width: 0;
            min-width: 0;
            padding: 0;
            margin: 0;
            opacity: 0;
            transform: translateX(-20px);
        }

        .sidebar-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .sidebar-logo {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .sidebar-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .sidebar-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            padding-right: 0.5rem;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 2px;
        }

        /* ========== STAT CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(199, 91, 57, 0.1) 0%, rgba(199, 91, 57, 0.05) 100%);
            border-color: rgba(199, 91, 57, 0.3);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--primary);
        }

        .stat-card.highlight .stat-value {
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
            font-weight: 600;
        }

        /* ========== SECTION HEADERS ========== */
        .section-header {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 1.5rem 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border-medium) 0%, transparent 100%);
        }

        /* ========== AGENT STATUS LIST ========== */
        .agent-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .agent-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .agent-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
            transform: translateX(3px);
        }

        .agent-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .agent-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 8px rgba(45, 139, 90, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.9); }
        }

        .agent-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* ========== TOPIC BUTTONS ========== */
        .topic-btn {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            font-size: 0.8rem;
            color: var(--text-primary);
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
        }

        .topic-btn:hover {
            background: linear-gradient(135deg, rgba(199, 91, 57, 0.08) 0%, rgba(199, 91, 57, 0.03) 100%);
            border-color: var(--accent);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .topic-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        /* ========== QUICK LINKS ========== */
        .quick-link {
            display: block;
            font-size: 0.75rem;
            color: var(--accent);
            text-decoration: none;
            padding: 0.4rem 0;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .quick-link:hover {
            color: var(--primary);
            transform: translateX(4px);
        }

        /* ========== CLEAR BUTTON ========== */
        .clear-btn {
            width: 100%;
            background: var(--error-light);
            color: var(--error);
            border: 1px solid rgba(199, 80, 80, 0.3);
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: rgba(199, 80, 80, 0.15);
            border-color: var(--error);
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem);
            overflow: hidden;
            min-width: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ========== HEADER ========== */
        .header {
            text-align: center;
            padding: 0.75rem 0;
            flex-shrink: 0;
        }

        .header-content {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.75rem, 5vw, 3rem);
            font-weight: 700;
            color: var(--primary);
            letter-spacing: -0.5px;
            line-height: 1.1;
        }

        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 0.4rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 2rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            box-shadow: var(--shadow-sm);
        }

        .badge-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* ========== CHAT CARD ========== */
        .chat-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 1.5rem;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            min-height: 0;
            margin-bottom: 0.75rem;
        }

        .chat-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 0.75rem;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: var(--success-light);
            border: 1px solid rgba(45, 139, 90, 0.3);
            border-radius: 2rem;
            font-size: 0.75rem;
            color: var(--success);
            font-weight: 600;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .chat-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .model-select {
            padding: 0.5rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .model-select:hover, .model-select:focus {
            border-color: var(--accent);
            outline: none;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
        }

        .toggle-label input {
            accent-color: var(--accent);
        }

        .analytics-btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .analytics-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--accent-glow);
        }

        /* ========== AGENT FLOW VISUALIZATION ========== */
        .agent-flow {
            padding: 1rem 1.25rem;
            background: linear-gradient(90deg, var(--warning-light) 0%, rgba(255, 243, 205, 0.5) 100%);
            border-bottom: 1px solid rgba(199, 140, 60, 0.2);
            display: none;
        }

        .agent-flow.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .agent-flow-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--warning);
        }

        .agent-flow-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(199, 140, 60, 0.3);
            border-top-color: var(--warning);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .agent-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .agent-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .agent-indicator.active {
            background: var(--success-light);
            border: 1px solid rgba(45, 139, 90, 0.3);
            color: var(--success);
        }

        .agent-indicator.active::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }

        .agent-indicator.waiting {
            background: var(--warning-light);
            border: 1px solid rgba(199, 140, 60, 0.3);
            color: var(--warning);
        }

        .agent-indicator.complete {
            background: var(--info-light);
            border: 1px solid rgba(74, 124, 155, 0.3);
            color: var(--info);
        }

        .agent-indicator.complete::before {
            content: 'âœ“';
            font-size: 0.6rem;
        }

        /* ========== CHAT MESSAGES ========== */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
            min-height: 0;
            scroll-behavior: smooth;
            background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-card) 100%);
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .message {
            animation: messageIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 1rem;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .message.bot {
            display: flex;
            justify-content: flex-start;
        }

        .message-bubble {
            position: relative;
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: 1.25rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .message.bot .message-bubble {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            border-bottom-left-radius: 0.25rem;
            box-shadow: var(--shadow-sm);
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 10px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0;
        }

        .message-bubble:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ========== TYPING INDICATOR ========== */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        .loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* ========== SUGGESTED QUESTIONS ========== */
        .suggested-questions {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-light);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            flex-shrink: 0;
            background: var(--bg-secondary);
        }

        .suggested-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            padding: 0.6rem 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-weight: 500;
        }

        .suggested-btn:hover {
            background: linear-gradient(135deg, rgba(199, 91, 57, 0.08) 0%, rgba(199, 91, 57, 0.03) 100%);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* ========== INPUT SECTION ========== */
        .input-section {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
            margin-bottom: 0.5rem;
        }

        .input-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .input-row input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-primary);
            outline: none;
            transition: all 0.3s ease;
        }

        .input-row input::placeholder {
            color: var(--text-light);
        }

        .input-row input:focus {
            border-color: var(--accent);
            background: var(--bg-card);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--accent-glow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px var(--accent-glow);
        }

        .send-btn:active {
            transform: scale(0.98);
        }

        /* ========== UPLOAD SECTION ========== */
        .upload-section {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .upload-section label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .upload-section input[type="file"] {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .upload-section input[type="file"]::file-selector-button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            color: var(--text-primary);
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            margin-right: 0.75rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .upload-section input[type="file"]::file-selector-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .upload-btn {
            background: linear-gradient(135deg, var(--success) 0%, #247A4C 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(45, 139, 90, 0.25);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(45, 139, 90, 0.3);
        }

        #uploadStatus {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ========== HAMBURGER BUTTON ========== */
        .hamburger-btn {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 200;
            background: var(--bg-card);
            color: var(--primary);
            border: 1px solid var(--border-light);
            width: 44px;
            height: 44px;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hamburger-btn:hover {
            transform: scale(1.05);
            border-color: var(--accent);
            box-shadow: var(--shadow-lg);
        }

        /* ========== SIDEBAR OVERLAY ========== */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(74, 44, 42, 0.3);
            backdrop-filter: blur(4px);
            z-index: 99;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* ========== TOAST NOTIFICATIONS ========== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            color: white;
            font-weight: 500;
            font-size: 0.85rem;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100px) scale(0.9); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }

        .toast.success { 
            background: linear-gradient(135deg, var(--success) 0%, #247A4C 100%);
        }
        .toast.error { 
            background: linear-gradient(135deg, var(--error) 0%, #A83D3D 100%);
        }
        .toast.info { 
            background: linear-gradient(135deg, var(--info) 0%, #3A6B85 100%);
        }
        .toast.warning { 
            background: linear-gradient(135deg, var(--warning) 0%, #A87530 100%);
        }

        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(74, 44, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 9998;
            overflow: hidden;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 1.5rem;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            animation: modalContentIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalContentIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 3px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .modal-close {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--error-light);
            border-color: var(--error);
            color: var(--error);
        }

        /* Analytics Modal Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analytics-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .analytics-card .value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
        }

        .analytics-card .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
            font-weight: 600;
        }

        /* ========== HEATMAP MODAL ========== */
        .heatmap-content {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 1.5rem;
            max-width: 1200px;
            width: 100%;
            height: 90vh;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: modalContentIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .heatmap-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .heatmap-header h2 {
            font-family: 'Playfair Display', serif;
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .heatmap-header p {
            margin: 0.25rem 0 0;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .heatmap-filters {
            padding: 1rem 1.25rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .filter-btn.primary:hover {
            transform: translateY(-2px);
        }

        .filter-btn.secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-medium);
        }

        .filter-btn.secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .heatmap-body {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
            min-height: 0;
        }

        .heatmap-map-container {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #heatmapViewDiv {
            flex: 1;
            border-radius: 1rem;
            min-height: 0;
            border: 1px solid var(--border-light);
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .legend-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .legend-dot.high { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .legend-dot.medium { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .legend-dot.low { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); }

        .heatmap-stats {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow-y: auto;
            min-height: 0;
            padding-right: 0.5rem;
        }

        .heatmap-stats::-webkit-scrollbar {
            width: 4px;
        }
        .heatmap-stats::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 2px;
        }

        .stats-section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 0.25rem;
        }

        .stats-section-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 0 0 0.75rem;
        }

        .borough-card {
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .borough-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .borough-card.selected {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(199, 91, 57, 0.1) 0%, rgba(199, 91, 57, 0.05) 100%);
        }

        .borough-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .borough-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .risk-badge {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            border-radius: 2rem;
            font-weight: 600;
        }

        .risk-badge.high {
            background: var(--error-light);
            color: var(--error);
        }

        .risk-badge.medium {
            background: var(--warning-light);
            color: var(--warning);
        }

        .risk-badge.low {
            background: var(--success-light);
            color: var(--success);
        }

        .borough-complaints {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .risk-bar-container {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .risk-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.8s ease;
        }

        .summary-card {
            background: linear-gradient(135deg, rgba(199, 91, 57, 0.1) 0%, rgba(199, 91, 57, 0.05) 100%);
            border: 1px solid rgba(199, 91, 57, 0.2);
            border-radius: 1rem;
            padding: 1rem;
        }

        .summary-title {
            font-family: 'Playfair Display', serif;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent);
            margin: 0 0 0.75rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .summary-row:last-child {
            margin-bottom: 0;
        }

        .summary-row .label {
            color: var(--text-muted);
        }

        .summary-row .value {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .ai-insights-card {
            background: var(--info-light);
            border: 1px solid rgba(74, 124, 155, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            display: none;
        }

        .ai-insights-card.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .ai-insights-title {
            font-family: 'Playfair Display', serif;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--info);
            margin: 0 0 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-insights-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ========== FORMATTED RESPONSE STYLES ========== */
        .message-bubble h1, .message-bubble h2, .message-bubble h3, .message-bubble h4 {
            color: var(--primary);
            margin: 1em 0 0.5em;
            font-weight: 700;
        }

        .message-bubble h1:first-child, .message-bubble h2:first-child, 
        .message-bubble h3:first-child, .message-bubble h4:first-child {
            margin-top: 0;
        }

        .message.bot .message-bubble strong {
            color: var(--accent);
        }

        .message.user .message-bubble strong {
            color: white;
        }

        .message-bubble ul, .message-bubble ol {
            padding-left: 1.5rem;
            margin: 0.5em 0;
        }

        .message-bubble li {
            margin-bottom: 0.25em;
        }

        .message-bubble code {
            background: var(--bg-secondary);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
        }

        .message-bubble pre {
            background: var(--text-primary);
            color: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.75em 0;
        }

        .message-bubble pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .message-bubble table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75em 0;
            font-size: 0.85em;
        }

        .message-bubble th {
            background: var(--primary);
            color: white;
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .message-bubble td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }

        .message-bubble tr:hover {
            background: var(--bg-secondary);
        }

        .pro-tip {
            background: var(--warning-light);
            border-left: 3px solid var(--warning);
            padding: 0.75rem 1rem;
            margin: 0.75em 0;
            border-radius: 0 0.5rem 0.5rem 0;
            font-size: 0.85em;
        }

        .source-citation {
            color: var(--text-muted);
            font-size: 0.7rem;
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }

        .source-legend {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-light);
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1024px) {
            .app-container {
                padding: 0.75rem;
                gap: 0.75rem;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                border-radius: 0 1.5rem 1.5rem 0;
                z-index: 1000;
            }

            .sidebar.closed {
                transform: translateX(-100%);
                width: 300px;
            }

            .heatmap-body {
                grid-template-columns: 1fr;
            }

            .heatmap-stats {
                max-height: 200px;
            }
        }

        @media (max-width: 640px) {
            .app-container {
                padding: 0.5rem;
            }

            .suggested-questions {
                grid-template-columns: 1fr;
            }

            .heatmap-content {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }

            .chat-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .chat-controls {
                width: 100%;
                justify-content: flex-start;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============ ENHANCED ARCGIS FEATURES FOR FRIDAY DEMO ============ */
        
        /* Map View Toggle */
        .map-view-toggle {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 10;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toggle-button {
            padding: 10px 16px;
            border: 2px solid var(--border-medium);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-button:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .toggle-button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Layer Controls */
        .layer-controls {
            position: absolute;
            top: 220px;
            right: 20px;
            z-index: 10;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 16px;
            min-width: 280px;
        }

        .layer-controls h4 {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .layer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .layer-item:hover {
            background: var(--bg-secondary);
        }

        .layer-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .layer-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .layer-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Infographics Panel */
        .infographics-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(250,234,229,0.98) 100%);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 20px;
            min-width: 350px;
            max-width: 400px;
            border: 2px solid var(--border-light);
            display: none;
        }

        .infographics-panel.visible {
            display: block;
            animation: slideInLeft 0.4s ease;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .infographics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-light);
        }

        .infographics-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .infographics-close {
            background: transparent;
            border: none;
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .infographics-close:hover {
            background: var(--bg-secondary);
            color: var(--accent);
        }

        .demographic-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
        }

        .demographic-card {
            background: white;
            padding: 14px;
            border-radius: 10px;
            border: 1.5px solid var(--border-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .demographic-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .demographic-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 800;
            color: var(--accent);
        }

        .demographic-subtitle {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .infographics-footer {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
        }

    </style>
</head>
<body>
    <!-- Hamburger Menu Button -->
    <button id="hamburgerBtn" class="hamburger-btn" aria-label="Toggle sidebar">â˜°</button>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar - NOW OPEN BY DEFAULT -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-content">
                <!-- Sidebar Header -->
                <div class="sidebar-header">
                    <div class="sidebar-logo">ðŸ³</div>
                    <div>
                        <div class="sidebar-title">Kitchen Compass</div>
                        <div class="sidebar-subtitle">v2.0 Multi-Agent AI</div>
                    </div>
                </div>

                <div class="sidebar-scroll">
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card highlight">
                            <div class="stat-value" id="sidebarDocs">5000</div>
                            <div class="stat-label">Documents Chunks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="sidebarQuestions">0</div>
                            <div class="stat-label">Questions</div>
                        </div>
                        <div class="stat-card" style="grid-column: span 2;">
                            <div class="stat-value" id="sidebarAvgTime">0s</div>
                            <div class="stat-label">Avg Response Time</div>
                        </div>
                    </div>

                    <!-- Agent Status -->
                    <div class="section-header">ðŸ¤– AI Agents</div>
                    <div class="agent-list" id="agentStatusList">
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Intent Router</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Complaint Analyzer</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Compliance Guide</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Location Risk</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Strategic Advisor</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Violation Prevention</span>
                            <span class="agent-count">0</span>
                        </div>
                    </div>

                    <!-- Popular Topics -->
                    <div class="section-header">ðŸŽ¯ Quick Actions</div>
                    <button class="topic-btn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);">ðŸ“‹</div>
                        <span>Permits & Licenses</span>
                    </button>
                    <button class="topic-btn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">ðŸ¥</div>
                        <span>Health Inspections</span>
                    </button>
                    <button class="topic-btn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);">ðŸ“</div>
                        <span>Location Analysis</span>
                    </button>
                    <button class="topic-btn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">âš ï¸</div>
                        <span>Common Violations</span>
                    </button>
                    <button class="topic-btn" id="heatmapBtn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">ðŸ—ºï¸</div>
                        <span>Complaint Density Heatmap</span>
                    </button>

                    <!-- Quick Links -->
                    <div class="section-header">ðŸ”— Resources</div>
                    <a href="https://www1.nyc.gov/nycbusiness/description/food-service-establishment-permit" target="_blank" class="quick-link">â†’ NYC Food Permits</a>
                    <a href="https://www1.nyc.gov/site/doh/index.page" target="_blank" class="quick-link">â†’ NYC Health Dept</a>
                    <a href="https://www1.nyc.gov/site/sbs/index.page" target="_blank" class="quick-link">â†’ Small Business Services</a>

                    <!-- Clear History -->
                    <button id="clearHistory" class="clear-btn">ðŸ—‘ï¸ Clear Chat History</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <h1>Kitchen Compass AI</h1>
                    <div class="header-badge">
                        <span class="badge-dot"></span>
                        <span>Multi-Agent System for NYC Restaurant Entrepreneurs</span>
                    </div>
                </div>
            </div>

            <!-- Chat Card -->
            <div class="chat-card">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-status">
                        <div class="status-indicator">
                            <span class="status-dot"></span>
                            <span>Online</span>
                        </div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Kitchen Compass AI v2.0</span>
                    </div>
                    <div class="chat-controls">
                        <select id="modelSelector" class="model-select">
                            <option value="gpt-4o-mini" selected>ðŸ¤– GPT-4o-mini</option>
                            <option value="ollama">ðŸ¦™ Ollama</option>
                        </select>
                        <label class="toggle-label">
                            <input type="checkbox" id="streamToggle">
                            <span>Stream</span>
                        </label>
                        <button id="showAnalytics" class="analytics-btn">ðŸ“Š Analytics</button>
                    </div>
                </div>

                <!-- Agent Flow Visualization -->
                <div id="agentFlow" class="agent-flow">
                    <div class="agent-flow-header">
                        <div class="agent-flow-spinner"></div>
                        <span>Agent Execution Flow</span>
                    </div>
                    <div id="agentIndicators" class="agent-indicators"></div>
                </div>

                <!-- Chat Messages -->
                <div id="chatContainer" class="chat-container">
                    <div class="message bot">
                        <div class="message-bubble">
                            <p style="margin: 0 0 1rem 0;">
                                <strong style="font-size: 1.1em;">ðŸ‘‹ Welcome to Kitchen Compass AI!</strong><br>
                                <span style="color: var(--text-secondary);">Your NYC restaurant setup copilot powered by 6 specialized AI agents.</span>
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin: 1rem 0;">
                                <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.5rem; font-size: 0.8rem; border: 1px solid var(--border-light);">
                                    ðŸ§­ <strong>Intent Router</strong><br>
                                    <span style="color: var(--text-muted);">Smart query routing</span>
                                </div>
                                <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.5rem; font-size: 0.8rem; border: 1px solid var(--border-light);">
                                    ðŸ“Š <strong>Complaint Analyzer</strong><br>
                                    <span style="color: var(--text-muted);">311 data insights</span>
                                </div>
                                <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.5rem; font-size: 0.8rem; border: 1px solid var(--border-light);">
                                    âœ… <strong>Compliance Guide</strong><br>
                                    <span style="color: var(--text-muted);">Health code expert</span>
                                </div>
                                <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.5rem; font-size: 0.8rem; border: 1px solid var(--border-light);">
                                    ðŸ“ <strong>Location Risk</strong><br>
                                    <span style="color: var(--text-muted);">Neighborhood analysis</span>
                                </div>
                                <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.5rem; font-size: 0.8rem; border: 1px solid var(--border-light);">
                                    ðŸ’¡ <strong>Strategic Advisor</strong><br>
                                    <span style="color: var(--text-muted);">Business strategy</span>
                                </div>
                                <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.5rem; font-size: 0.8rem; border: 1px solid var(--border-light);">
                                    ðŸ›¡ï¸ <strong>Violation Prevention</strong><br>
                                    <span style="color: var(--text-muted);">Proactive compliance</span>
                                </div>
                            </div>
                            <p style="margin: 0; padding: 0.75rem; background: linear-gradient(135deg, rgba(199, 91, 57, 0.1) 0%, rgba(199, 91, 57, 0.05) 100%); border: 1px solid rgba(199, 91, 57, 0.2); border-radius: 0.5rem; font-size: 0.85rem;">
                                ðŸ’¡ <strong>Try:</strong> "Show me a heatmap of restaurant risks" or "What permits do I need?"
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Suggested Questions -->
                <div class="suggested-questions">
                    <button class="suggested-btn">What permits do I need to open a restaurant?</button>
                    <button class="suggested-btn">Show me a heatmap of NYC restaurant risks</button>
                    <button class="suggested-btn">What are the most common health violations?</button>
                    <button class="suggested-btn">Which neighborhood is safest for restaurants?</button>
                </div>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div class="input-row">
                    <input 
                        type="text" 
                        id="userInput" 
                        placeholder="Ask about permits, inspections, locations, violations, or business strategy..."
                    />
                    <button id="sendBtn" class="send-btn">â–¶</button>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="upload-section">
                <label>ðŸ“ Upload NYC Data (CSV):</label>
                <input type="file" id="csvFile" accept=".csv" />
                <button id="uploadBtn" class="upload-btn">Upload & Ingest</button>
                <span id="uploadStatus"></span>
            </div>
        </main>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ðŸ“Š System Analytics & Agent Performance</h2>
                <button id="closeAnalytics" class="modal-close">Ã—</button>
            </div>
            <div id="analyticsContent">
                <p style="color: var(--text-muted);">Loading analytics...</p>
            </div>
        </div>
    </div>

    <!-- Heatmap Modal -->
    <div id="heatmapModal" class="modal">
        <div class="heatmap-content">
            <!-- Header -->
            <div class="heatmap-header">
                <div>
                    <h2>ðŸ—ºï¸ NYC Restaurant Complaint Density Heatmap</h2>
                    <p>Interactive visualization of complaint density by borough</p>
                </div>
                <button id="closeHeatmapModal" class="modal-close" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">Ã—</button>
            </div>
            
            <!-- Filters -->
            <div class="heatmap-filters">
                <div class="filter-group">
                    <label>Filter by Borough:</label>
                    <select id="heatmapBoroughFilter" class="filter-select">
                        <option value="">ðŸ™ï¸ All Boroughs</option>
                        <option value="Manhattan">ðŸ¢ Manhattan</option>
                        <option value="Brooklyn">ðŸŒ‰ Brooklyn</option>
                        <option value="Queens">ðŸ‘‘ Queens</option>
                        <option value="Bronx">ðŸ¦ Bronx</option>
                        <option value="Staten Island">ðŸï¸ Staten Island</option>
                    </select>
                </div>
                <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                    <button id="applyHeatmapFilters" class="filter-btn primary">Apply Filter</button>
                    <button id="resetHeatmapFilters" class="filter-btn secondary">Reset</button>
                </div>
            </div>
            
            <!-- Map and Stats -->
            <div class="heatmap-body">
                <!-- Map Container -->
                <div class="heatmap-map-container">
                    <div id="heatmapViewDiv"></div>
                    
                    <!-- ========== ENHANCED FEATURES FOR FRIDAY DEMO ========== -->
                    
                    <!-- Map View Toggle Controls -->
                    <div class="map-view-toggle">
                        <button id="boroughViewBtn" class="toggle-button active">
                            ðŸ“ Borough View
                        </button>
                        <button id="densityViewBtn" class="toggle-button">
                            ðŸ”¥ Density Heatmap
                        </button>
                    </div>

                    <!-- Layer Controls -->
                    <div class="layer-controls">
                        <h4>ðŸ—ºï¸ Map Layers</h4>
                        <div class="layer-item" onclick="toggleDemographicLayer()">
                            <input type="checkbox" id="incomeLayerToggle" class="layer-checkbox">
                            <div style="flex: 1;">
                                <div class="layer-name">Household Income</div>
                                <div class="layer-desc">2025 Median Income</div>
                            </div>
                        </div>
                        <div class="layer-item" onclick="togglePopulationLayer()">
                            <input type="checkbox" id="populationLayerToggle" class="layer-checkbox">
                            <div style="flex: 1;">
                                <div class="layer-name">Population Density</div>
                                <div class="layer-desc">People per sq. mile</div>
                            </div>
                        </div>
                    </div>

                    <!-- Infographics Panel -->
                    <div id="infographicsPanel" class="infographics-panel">
                        <div class="infographics-header">
                            <div class="infographics-title" id="infoBoroughName">Brooklyn</div>
                            <button class="infographics-close" onclick="closeInfoPanel()">Ã—</button>
                        </div>
                        
                        <div class="demographic-grid">
                            <div class="demographic-card">
                                <div class="demographic-label">Population</div>
                                <div class="demographic-value" id="infoPop">2.7M</div>
                                <div class="demographic-subtitle">2025 Estimate</div>
                            </div>
                            
                            <div class="demographic-card">
                                <div class="demographic-label">Median Income</div>
                                <div class="demographic-value" id="infoIncome">$71K</div>
                                <div class="demographic-subtitle">Household/Year</div>
                            </div>
                            
                            <div class="demographic-card">
                                <div class="demographic-label">Median Age</div>
                                <div class="demographic-value" id="infoAge">35.2</div>
                                <div class="demographic-subtitle">Years</div>
                            </div>
                            
                            <div class="demographic-card">
                                <div class="demographic-label">Density</div>
                                <div class="demographic-value" id="infoDensity">37,137</div>
                                <div class="demographic-subtitle">People/sq mi</div>
                            </div>
                        </div>
                        
                        <div class="infographics-footer">
                            ðŸ“Š Data from US Census Bureau & NYC Open Data
                        </div>
                    </div>

                    
                    <!-- Legend -->
                    <div class="heatmap-legend">
                        <span class="legend-title">Risk Level:</span>
                        <div class="legend-item">
                            <div class="legend-dot high"></div>
                            <span>High (70+)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot medium"></div>
                            <span>Medium (40-69)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot low"></div>
                            <span>Low (0-39)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Sidebar -->
                <div class="heatmap-stats">
                    <h3 class="stats-section-title">ðŸ“Š Borough Statistics</h3>
                    <p class="stats-section-desc">Click a borough to zoom and see AI insights</p>
                    <div id="boroughStatsContainer"></div>
                    
                    <!-- Summary -->
                    <div class="summary-card">
                        <h4 class="summary-title">ðŸ“ˆ Summary</h4>
                        <div class="summary-row">
                            <span class="label">Total Complaints:</span>
                            <span class="value" id="summaryTotalComplaints" style="color: var(--text-primary);">0</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Highest Risk:</span>
                            <span class="value" id="summaryHighestRisk" style="color: var(--error);">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Lowest Risk:</span>
                            <span class="value" id="summaryLowestRisk" style="color: var(--success);">-</span>
                        </div>
                    </div>
                    
                    <!-- AI Insights -->
                    <div id="heatmapAIInsights" class="ai-insights-card">
                        <h4 class="ai-insights-title">ðŸ¤– AI Insights</h4>
                        <p id="heatmapAIText" class="ai-insights-text"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ArcGIS API -->
    <script src="https://js.arcgis.com/4.28/"></script>

    <script>
        // ========== ALL JAVASCRIPT - ENHANCED VISUALIZATION ==========
        
        // Global Variables
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const modelSelector = document.getElementById('modelSelector');
        const streamToggle = document.getElementById('streamToggle');
        const suggestedBtns = document.querySelectorAll('.suggested-btn');
        const uploadBtn = document.getElementById('uploadBtn');
        const csvFile = document.getElementById('csvFile');
        const uploadStatus = document.getElementById('uploadStatus');
        const showAnalyticsBtn = document.getElementById('showAnalytics');
        const analyticsModal = document.getElementById('analyticsModal');
        const closeAnalyticsBtn = document.getElementById('closeAnalytics');
        const analyticsContent = document.getElementById('analyticsContent');
        const clearHistoryBtn = document.getElementById('clearHistory');
        const topicBtns = document.querySelectorAll('.topic-btn');
        const agentFlow = document.getElementById('agentFlow');
        const agentIndicators = document.getElementById('agentIndicators');
        const agentStatusList = document.getElementById('agentStatusList');

        let questionCount = 0;
        let totalResponseTime = 0;

        // Heatmap variables
        let heatmapView = null;
        let heatmapGraphicsLayer = null;
        let ArcGISGraphic = null;

        // Heatmap trigger patterns
        const heatmapTriggerPatterns = [
            'heatmap', 'heat map', 'show map', 'show me a map', 
            'risk map', 'complaint map', 'visualize', 'visualization',
            'where should i open', 'safest neighborhood', 'safest borough',
            'highest risk', 'lowest risk', 'complaint hotspot', 'hotspot',
            'map of complaints', 'map of risks', 'show risk', 'show risks',
            'which area', 'which neighborhood', 'which borough is safest',
            'dangerous area', 'safe area', 'compare boroughs', 'borough comparison'
        ];

        function shouldTriggerHeatmap(message) {
            const lowerMessage = message.toLowerCase();
            return heatmapTriggerPatterns.some(pattern => lowerMessage.includes(pattern));
        }

        // ========== SIDEBAR - OPEN BY DEFAULT ON DESKTOP ==========
        const sidebar = document.getElementById('sidebar');
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function openSidebar() {
            sidebar.classList.remove('closed');
            sidebarOverlay.classList.add('active');
            if (window.innerWidth < 1024) {
                document.body.style.overflow = 'hidden';
            }
        }

        function closeSidebar() {
            sidebar.classList.add('closed');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function toggleSidebar() {
            if (sidebar.classList.contains('closed')) {
                openSidebar();
            } else {
                closeSidebar();
            }
        }

        hamburgerBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // FIXED: Sidebar open by default on desktop
        function initializeSidebar() {
            const isDesktop = window.innerWidth >= 1024;
            
            if (isDesktop) {
                // Desktop: Always open, no overlay
                sidebar.classList.remove('closed');
                sidebarOverlay.classList.remove('active');
            } else {
                // Mobile: Start closed
                sidebar.classList.add('closed');
                sidebarOverlay.classList.remove('active');
            }
        }

        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // Initialize sidebar on load
        initializeSidebar();

        // Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Agent Status
        async function loadAgentStatus() {
            try {
                const response = await fetch('/api/agents/status');
                const data = await response.json();

                if (data.ok && data.agents) {
                    updateAgentStatusSidebar(data.agents);
                }
            } catch (error) {
                console.error('Failed to load agent status:', error);
            }
        }

        function updateAgentStatusSidebar(agents) {
            agentStatusList.innerHTML = agents.map(agent => `
                <div class="agent-item">
                    <span class="agent-name"><span class="agent-dot"></span>${agent.name}</span>
                    <span class="agent-count">${agent.usage_count || 0}</span>
                </div>
            `).join('');
        }

        function showAgentIndicator(agentName, status = 'active') {
            const indicator = document.createElement('div');
            indicator.className = `agent-indicator ${status}`;
            indicator.id = `agent-${agentName}`;
            indicator.innerHTML = `<span>${agentName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>`;
            agentIndicators.appendChild(indicator);
            agentFlow.classList.add('active');
        }

        function updateAgentIndicator(agentName, status) {
            const indicator = document.getElementById(`agent-${agentName}`);
            if (indicator) {
                indicator.className = `agent-indicator ${status}`;
            }
        }

        function clearAgentIndicators() {
            agentIndicators.innerHTML = '';
            agentFlow.classList.remove('active');
        }

        // Stats Update
        function updateSidebarStats() {
            document.getElementById('sidebarQuestions').textContent = questionCount;
            const avgTime = questionCount > 0 ? (totalResponseTime / questionCount).toFixed(1) : 0;
            document.getElementById('sidebarAvgTime').textContent = avgTime + 's';
        }

        // Topic Buttons
        topicBtns.forEach(btn => {
            if (btn.id !== 'heatmapBtn') {
                btn.addEventListener('click', () => {
                    const topic = btn.querySelector('span').textContent.trim();
                    userInput.value = `Tell me about ${topic}`;
                    sendMessage();
                    
                    if (window.innerWidth < 1024) {
                        closeSidebar();
                    }
                });
            }
        });

        // Clear History
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the chat history?')) {
                chatContainer.innerHTML = '';
                questionCount = 0;
                totalResponseTime = 0;
                updateSidebarStats();
                showToast('Chat history cleared', 'success');
            }
        });

        // Suggested Questions
        suggestedBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.textContent.trim();
                userInput.value = question;
                sendMessage();
            });
        });

        // Send Message
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            questionCount++;
            updateSidebarStats();

            const selectedModel = modelSelector.value;
            const modelName = selectedModel === 'gpt-4o-mini' ? 'GPT-4o-mini' : 'Ollama';
            const useStreaming = streamToggle.checked;

            displayMessage(message, 'user');
            userInput.value = '';

            clearAgentIndicators();

            if (shouldTriggerHeatmap(message)) {
                displayMessage('ðŸ—ºï¸ Opening the NYC Restaurant Risk Heatmap for you! This interactive visualization shows complaint density and risk levels across all five boroughs.', 'bot');
                showToast('Opening Risk Heatmap...', 'info');
                
                setTimeout(() => {
                    openHeatmapModal();
                }, 500);
                
                generateResponse(message, selectedModel, modelName);
            } else if (useStreaming) {
                await streamResponse(message, selectedModel);
            } else {
                await generateResponse(message, selectedModel, modelName);
            }

            loadAgentStatus();
        }

        // Non-Streaming Response
        async function generateResponse(message, model, modelName) {
            const loadingId = displayMessage(`ðŸ¤– Thinking (${modelName})<span class="loading-dots"></span>`, 'bot', true);

            const startTime = Date.now();

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: message,
                        model: model,
                        stream: false
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId)?.remove();

                const executionTime = (Date.now() - startTime) / 1000;
                totalResponseTime += executionTime;
                updateSidebarStats();

                if (data.ok) {
                    let responseText = data.output;
                    
                    if (typeof responseText === 'object' && responseText !== null) {
                        responseText = responseText.text || responseText.content || JSON.stringify(responseText);
                    }
                    
                    displayMessage(responseText, 'bot');
                    showToast(`Response generated in ${executionTime.toFixed(1)}s`, 'success');
                } else {
                    displayMessage('Sorry, something went wrong. Please try again.', 'bot');
                    showToast('Failed to generate response', 'error');
                }
            } catch (error) {
                document.getElementById(loadingId)?.remove();
                displayMessage('Error connecting to server. Please try again.', 'bot');
                showToast('Connection error', 'error');
                console.error('Error:', error);
            }
        }

        // Streaming Response
        async function streamResponse(message, model) {
            const messageId = displayMessage('', 'bot', false, true);
            const messageBubble = document.getElementById(messageId).querySelector('.message-content');

            showAgentIndicator('intent_router', 'active');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: message,
                        model: model,
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let content = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'agent') {
                                    if (data.status === 'active') {
                                        showAgentIndicator(data.agent.toLowerCase().replace(/ /g, '_'), 'active');
                                    } else if (data.status === 'complete') {
                                        updateAgentIndicator(data.agent.toLowerCase().replace(/ /g, '_'), 'complete');
                                    }
                                } else if (data.type === 'content') {
                                    content += data.content;
                                    messageBubble.innerHTML = formatBotResponse(content);
                                } else if (data.type === 'done') {
                                    showToast('Response complete', 'success');
                                } else if (data.type === 'error') {
                                    showToast('Error: ' + data.error, 'error');
                                }
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }

                chatContainer.scrollTop = chatContainer.scrollHeight;
            } catch (error) {
                showToast('Streaming error', 'error');
                console.error('Streaming error:', error);
            }
        }

        // Display Message
        function displayMessage(text, sender, isLoading = false, isStreaming = false) {
            const messageDiv = document.createElement('div');
            const id = 'msg-' + Date.now();
            messageDiv.id = id;
            messageDiv.className = `message ${sender}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            if (sender === 'bot' && !isLoading && !isStreaming) {
                text = formatBotResponse(text);
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'ðŸ“‹ Copy';
                copyBtn.onclick = () => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = text;
                    navigator.clipboard.writeText(tempDiv.textContent);
                    copyBtn.textContent = 'âœ… Copied!';
                    setTimeout(() => copyBtn.textContent = 'ðŸ“‹ Copy', 2000);
                };
                bubble.appendChild(copyBtn);
            }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = text;
            bubble.appendChild(content);
            
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return id;
        }

        // Format Bot Response
        function formatBotResponse(text) {
            if (typeof text !== 'string') {
                text = String(text);
            }
            
            text = text.replace(/^#{1,4}\s+(.+)$/gm, '<div style="font-weight: 700; color: var(--primary); margin: 0.8em 0 0.4em 0; font-size: 1em;">$1</div>');
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/^[\-\â€¢\*]\s+(.+)$/gm, '<div style="margin: 0.3em 0 0.3em 0.8em; padding-left: 0.6em; border-left: 2px solid var(--accent);">$1</div>');
            text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin: 0.3em 0 0.3em 0.8em;"><span style="color: var(--accent); font-weight: 600;">$1.</span> $2</div>');
            text = text.replace(/ðŸ’¡\s*Pro Tip:?\s*(.+?)(?=\n\n|$)/gs, '<div class="pro-tip">ðŸ’¡ <strong>Pro Tip:</strong> $1</div>');
            text = text.replace(/\[Source\s*(\d+)\]/g, '<span class="source-citation">[Source $1]</span>');
            text = text.replace(/---\nðŸ“š Sources:/g, '<div class="source-legend">ðŸ“š <strong>Sources:</strong></div>');
            text = text.replace(/\n\n/g, '<br><br>');
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        // CSV Upload
        uploadBtn.addEventListener('click', async () => {
            const file = csvFile.files[0];
            if (!file) {
                showToast('Please select a CSV file first', 'warning');
                uploadStatus.textContent = 'âš ï¸ Please select a CSV file first.';
                uploadStatus.style.color = 'var(--warning)';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            uploadStatus.textContent = 'â³ Uploading and processing...';
            uploadStatus.style.color = 'var(--info)';

            try {
                const response = await fetch('/api/ingest_csv', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.ok) {
                    uploadStatus.textContent = `âœ… Success! Ingested ${data.rows_ingested || 0} rows. Vector store has ${data.total_chunks || 0} chunks.`;
                    uploadStatus.style.color = 'var(--success)';
                    document.getElementById('sidebarDocs').textContent = data.total_chunks || 0;
                    showToast(`Successfully ingested ${data.rows_ingested} rows`, 'success');
                } else {
                    uploadStatus.textContent = 'âŒ Upload failed. Please try again.';
                    uploadStatus.style.color = 'var(--error)';
                    showToast('Upload failed', 'error');
                }
            } catch (error) {
                uploadStatus.textContent = 'âŒ Error uploading file.';
                uploadStatus.style.color = 'var(--error)';
                showToast('Upload error', 'error');
                console.error('Upload error:', error);
            }
        });

        // Analytics Modal
        showAnalyticsBtn.addEventListener('click', async () => {
            analyticsModal.classList.add('active');
            analyticsContent.innerHTML = '<p style="color: var(--text-muted);">Loading analytics...</p>';

            try {
                const response = await fetch('/api/analytics/overview');
                const data = await response.json();

                if (data.ok) {
                    const currentModel = modelSelector.options[modelSelector.selectedIndex].text;
                    
                    let agentUsageHTML = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">';
                    if (data.overview.agent_usage && Object.keys(data.overview.agent_usage).length > 0) {
                        for (const [agent, count] of Object.entries(data.overview.agent_usage)) {
                            agentUsageHTML += `
                                <div class="analytics-card">
                                    <div class="value">${count}</div>
                                    <div class="label">${agent.replace(/_/g, ' ')}</div>
                                </div>
                            `;
                        }
                    } else {
                        agentUsageHTML += '<p style="grid-column: span 3; color: var(--text-muted); text-align: center;">No agent usage data yet</p>';
                    }
                    agentUsageHTML += '</div>';

                    analyticsContent.innerHTML = `
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <div class="value">${data.overview.total_chunks || 0}</div>
                                <div class="label">Vector Store Chunks</div>
                            </div>
                            <div class="analytics-card">
                                <div class="value">${data.overview.total_queries || 0}</div>
                                <div class="label">Queries Processed</div>
                            </div>
                            <div class="analytics-card">
                                <div class="value">${data.overview.avg_execution_time || 0}s</div>
                                <div class="label">Avg Execution Time</div>
                            </div>
                            <div class="analytics-card">
                                <div class="value" style="font-size: 1rem;">${currentModel}</div>
                                <div class="label">Current Model</div>
                            </div>
                        </div>
                        
                        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1rem; font-family: 'Playfair Display', serif;">Agent Usage Statistics</h3>
                        ${agentUsageHTML}

                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.75rem; margin-top: 1.5rem; border: 1px solid var(--border-light);">
                            <p style="margin: 0; color: var(--text-primary);"><strong>System Status:</strong> ${data.overview.total_chunks > 0 ? 'âœ… Operational with data' : 'âš ï¸ No data ingested yet'}</p>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.85rem;"><strong>Tip:</strong> Upload NYC restaurant inspection data (CSV) to enhance insights!</p>
                        </div>
                    `;
                    
                    document.getElementById('sidebarDocs').textContent = data.overview.total_chunks || 0;
                } else {
                    analyticsContent.innerHTML = '<p style="color: var(--error);">Failed to load analytics.</p>';
                }
            } catch (error) {
                analyticsContent.innerHTML = '<p style="color: var(--error);">Error loading analytics.</p>';
                console.error('Analytics error:', error);
            }
        });

        closeAnalyticsBtn.addEventListener('click', () => {
            analyticsModal.classList.remove('active');
        });

        analyticsModal.addEventListener('click', (e) => {
            if (e.target === analyticsModal) {
                analyticsModal.classList.remove('active');
            }
        });

        // Heatmap Functions
        const heatmapModal = document.getElementById('heatmapModal');
        const heatmapBtn = document.getElementById('heatmapBtn');
        const closeHeatmapBtn = document.getElementById('closeHeatmapModal');
        const applyHeatmapFiltersBtn = document.getElementById('applyHeatmapFilters');
        const resetHeatmapFiltersBtn = document.getElementById('resetHeatmapFilters');
        const heatmapBoroughFilter = document.getElementById('heatmapBoroughFilter');

        function openHeatmapModal() {
            heatmapModal.classList.add('active');
            if (window.innerWidth < 1024) {
                closeSidebar();
            }
            setTimeout(() => {
                initHeatmap();
            }, 100);
        }

        heatmapBtn.addEventListener('click', openHeatmapModal);

        closeHeatmapBtn.addEventListener('click', () => {
            heatmapModal.classList.remove('active');
        });

        heatmapModal.addEventListener('click', (e) => {
            if (e.target === heatmapModal) {
                heatmapModal.classList.remove('active');
            }
        });

        // Initialize ArcGIS Heatmap with Professional Visualization
        function initHeatmap() {
            if (heatmapView) {
                loadHeatmapData();
                loadBoroughStats();
                return;
            }

            require([
                "esri/Map",
                "esri/views/MapView",
                "esri/layers/FeatureLayer",
                "esri/layers/GraphicsLayer",
                "esri/Graphic",
                "esri/renderers/HeatmapRenderer"
            ], function(Map, MapView, FeatureLayer, GraphicsLayer, Graphic, HeatmapRenderer) {
                
                window.ArcGISGraphic = Graphic;
                
                const map = new Map({
                    basemap: "gray-vector"
                });

                // Create graphics layer for markers (not labels)
                heatmapGraphicsLayer = new GraphicsLayer();
                map.add(heatmapGraphicsLayer);

                heatmapView = new MapView({
                    container: "heatmapViewDiv",
                    map: map,
                    center: [-74.0060, 40.7128],
                    zoom: 10,
                    ui: {
                        components: ["zoom", "compass"]
                    },
                    popup: {
                        dockEnabled: false,
                        dockOptions: {
                            buttonEnabled: false,
                            breakpoint: false
                        }
                    }
                });

                heatmapView.when(() => {
                    console.log("âœ… ArcGIS Map initialized successfully");
                    loadHeatmapData();
                    loadBoroughStats();
                });
            });
        }

        // Load heatmap data
        async function loadHeatmapData(borough = '') {
            const sampleData = {
                ok: true,
                features: [
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-73.9712, 40.7831] },
                        properties: { borough: "Manhattan", complaint_count: 245, risk_score: 72, risk_level: "High" }
                    },
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-73.9442, 40.6782] },
                        properties: { borough: "Brooklyn", complaint_count: 312, risk_score: 78, risk_level: "High" }
                    },
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-73.7949, 40.7282] },
                        properties: { borough: "Queens", complaint_count: 189, risk_score: 65, risk_level: "Medium" }
                    },
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-73.8648, 40.8448] },
                        properties: { borough: "Bronx", complaint_count: 156, risk_score: 61, risk_level: "Medium" }
                    },
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-74.1502, 40.5795] },
                        properties: { borough: "Staten Island", complaint_count: 67, risk_score: 42, risk_level: "Low" }
                    }
                ],
                summary: {
                    total_complaints: 969,
                    highest_risk: "Brooklyn",
                    lowest_risk: "Staten Island"
                }
            };

            try {
                let url = '/api/heatmap/data';
                if (borough) {
                    url += `?borough=${encodeURIComponent(borough)}`;
                }

                console.log("ðŸ“¡ Fetching heatmap data from:", url);
                const response = await fetch(url);
                const data = await response.json();
                
                console.log("ðŸ“Š Heatmap API response:", data);

                if (data.ok && data.features && data.features.length > 0) {
                    let features = data.features;
                    if (borough) {
                        features = features.filter(f => 
                            f.properties.borough.toLowerCase() === borough.toLowerCase()
                        );
                    }
                    addMarkersToMap(features);
                    if (data.summary) {
                        updateHeatmapSummary(data.summary);
                    }
                    showToast(`Loaded ${features.length} borough markers`, 'success');
                } else {
                    console.warn("API returned no data, using fallback sample data");
                    let features = sampleData.features;
                    if (borough) {
                        features = features.filter(f => 
                            f.properties.borough.toLowerCase() === borough.toLowerCase()
                        );
                    }
                    addMarkersToMap(features);
                    updateHeatmapSummary(sampleData.summary);
                    showToast(`Loaded ${features.length} sample markers`, 'info');
                }
            } catch (error) {
                console.error('API failed, using fallback sample data:', error);
                let features = sampleData.features;
                if (borough) {
                    features = features.filter(f => 
                        f.properties.borough.toLowerCase() === borough.toLowerCase()
                    );
                }
                addMarkersToMap(features);
                updateHeatmapSummary(sampleData.summary);
                showToast('Using sample data', 'info');
            }
        }

        // Add clean markers to map - NO LABELS, only interactive popups
        function addMarkersToMap(features) {
            if (!heatmapGraphicsLayer || !window.ArcGISGraphic) {
                console.error("ArcGIS not initialized yet, retrying in 500ms...");
                setTimeout(() => addMarkersToMap(features), 500);
                return;
            }

            console.log("ðŸŽ¯ Creating", features.length, "professional markers");
            
            heatmapGraphicsLayer.removeAll();

            features.forEach(feature => {
                const props = feature.properties;
                const coords = feature.geometry.coordinates;
                
                // Validate data
                if (!props.borough || !coords || coords.length < 2) {
                    console.warn("âš ï¸ Skipping invalid feature:", props);
                    return;
                }
                
                console.log("âœ“ Creating marker for:", props.borough);
                
                // Risk-based color scheme
                let color, glowColor, outlineColor;
                if (props.risk_score >= 70) {
                    color = [239, 68, 68, 0.85];
                    glowColor = [239, 68, 68, 0.2];
                    outlineColor = [185, 28, 28, 1];
                } else if (props.risk_score >= 40) {
                    color = [251, 191, 36, 0.85];
                    glowColor = [251, 191, 36, 0.2];
                    outlineColor = [217, 119, 6, 1];
                } else {
                    color = [74, 222, 128, 0.85];
                    glowColor = [74, 222, 128, 0.2];
                    outlineColor = [34, 197, 94, 1];
                }

                // Dynamic sizing - LARGER for better visibility
                const baseSize = 80;
                const maxSize = 180;
                const complaintCount = props.complaint_count || 0;
                const size = Math.min(maxSize, Math.max(baseSize, complaintCount / 2));
                
                // Outer glow (largest) - creates soft blur effect
                const outerGlow = new window.ArcGISGraphic({
                    geometry: {
                        type: "point",
                        longitude: coords[0],
                        latitude: coords[1]
                    },
                    symbol: {
                        type: "simple-marker",
                        style: "circle",
                        color: glowColor,
                        outline: { width: 0 },
                        size: size * 2.5
                    }
                });
                heatmapGraphicsLayer.add(outerGlow);

                // Middle glow (creates depth)
                const middleGlow = new window.ArcGISGraphic({
                    geometry: {
                        type: "point",
                        longitude: coords[0],
                        latitude: coords[1]
                    },
                    symbol: {
                        type: "simple-marker",
                        style: "circle",
                        color: [...glowColor.slice(0, 3), 0.35],
                        outline: { width: 0 },
                        size: size * 1.5
                    }
                });
                heatmapGraphicsLayer.add(middleGlow);

                // Main marker with enhanced popup
                const markerGraphic = new window.ArcGISGraphic({
                    geometry: {
                        type: "point",
                        longitude: coords[0],
                        latitude: coords[1]
                    },
                    symbol: {
                        type: "simple-marker",
                        style: "circle",
                        color: color,
                        outline: {
                            color: outlineColor,
                            width: 5
                        },
                        size: size
                    },
                    attributes: props,
                    popupTemplate: {
                        title: "<div style='font-size: 20px; font-weight: bold; color: #722F37; font-family: Playfair Display, serif; padding: 8px 0;'>ðŸ“ {borough}</div>",
                        content: `
                            <div style="padding: 18px; font-family: 'Source Sans 3', sans-serif; min-width: 320px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div style="background: linear-gradient(135deg, #F5DDD5 0%, #FAEAE5 100%); padding: 18px; border-radius: 12px; text-align: center; border: 2px solid rgba(199, 91, 57, 0.25); box-shadow: 0 4px 12px rgba(0,0,0,0.06);">
                                        <div style="font-size: 32px; font-weight: 800; color: #C75B39; font-family: 'JetBrains Mono', monospace; line-height: 1;">{complaint_count}</div>
                                        <div style="font-size: 11px; color: #6B4744; text-transform: uppercase; letter-spacing: 0.8px; margin-top: 8px; font-weight: 700;">Total Complaints</div>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #F5DDD5 0%, #FAEAE5 100%); padding: 18px; border-radius: 12px; text-align: center; border: 2px solid rgba(199, 91, 57, 0.25); box-shadow: 0 4px 12px rgba(0,0,0,0.06);">
                                        <div style="font-size: 32px; font-weight: 800; color: #C75B39; font-family: 'JetBrains Mono', monospace; line-height: 1;">{risk_score}</div>
                                        <div style="font-size: 11px; color: #6B4744; text-transform: uppercase; letter-spacing: 0.8px; margin-top: 8px; font-weight: 700;">Risk Score</div>
                                    </div>
                                </div>
                                <div style="background: ${props.risk_level === 'High' ? 'linear-gradient(135deg, #F8D7DA 0%, #F8D7DA 100%)' : props.risk_level === 'Medium' ? 'linear-gradient(135deg, #FFF3CD 0%, #FFF3CD 100%)' : 'linear-gradient(135deg, #D4EDDA 0%, #D4EDDA 100%)'}; 
                                            padding: 14px 18px; border-radius: 10px; text-align: center; 
                                            color: ${props.risk_level === 'High' ? '#C75050' : props.risk_level === 'Medium' ? '#C78C3C' : '#2D8B5A'}; 
                                            font-weight: 800; font-size: 15px; border: 2px solid ${props.risk_level === 'High' ? 'rgba(199, 80, 80, 0.35)' : props.risk_level === 'Medium' ? 'rgba(199, 140, 60, 0.35)' : 'rgba(45, 139, 90, 0.35)'};
                                            box-shadow: 0 3px 10px rgba(0,0,0,0.08); letter-spacing: 0.5px;">
                                    ${props.risk_level === 'High' ? 'ðŸ”´' : props.risk_level === 'Medium' ? 'ðŸŸ¡' : 'ðŸŸ¢'} ${props.risk_level.toUpperCase()} RISK BOROUGH
                                </div>
                            </div>
                        `
                    }
                });
                heatmapGraphicsLayer.add(markerGraphic);

                // Inner highlight (creates 3D effect)
                const highlight = new window.ArcGISGraphic({
                    geometry: {
                        type: "point",
                        longitude: coords[0],
                        latitude: coords[1]
                    },
                    symbol: {
                        type: "simple-marker",
                        style: "circle",
                        color: [255, 255, 255, 0.6],
                        outline: { width: 0 },
                        size: size * 0.3
                    }
                });
                heatmapGraphicsLayer.add(highlight);
            });
            
            console.log(`âœ… Created ${features.length} markers with ${heatmapGraphicsLayer.graphics.length} total graphics`);
            
            // Add borough labels as text annotations (separate from markers)
            addBoroughLabels(features);
        }
        
        // Add clean borough labels as separate text layer
        function addBoroughLabels(features) {
            if (!heatmapView || !window.ArcGISGraphic) return;
            
            // Create a separate graphics layer for labels if it doesn't exist
            if (!window.boroughLabelsLayer) {
                require(["esri/layers/GraphicsLayer"], function(GraphicsLayer) {
                    window.boroughLabelsLayer = new GraphicsLayer({
                        title: "Borough Labels"
                    });
                    heatmapView.map.add(window.boroughLabelsLayer);
                    
                    // Now add the labels
                    addLabelsToLayer(features);
                });
            } else {
                window.boroughLabelsLayer.removeAll();
                addLabelsToLayer(features);
            }
        }
        
        function addLabelsToLayer(features) {
            if (!window.boroughLabelsLayer || !window.ArcGISGraphic) return;
            
            features.forEach(feature => {
                const props = feature.properties;
                const coords = feature.geometry.coordinates;
                
                if (!props.borough || !coords) return;
                
                // Get size to position label appropriately
                const baseSize = 80;
                const maxSize = 180;
                const complaintCount = props.complaint_count || 0;
                const size = Math.min(maxSize, Math.max(baseSize, complaintCount / 2));
                
                // Create clean label above marker
                const labelGraphic = new window.ArcGISGraphic({
                    geometry: {
                        type: "point",
                        longitude: coords[0],
                        latitude: coords[1]
                    },
                    symbol: {
                        type: "text",
                        color: [74, 44, 42, 1],
                        haloColor: [255, 255, 255, 1],
                        haloSize: "4px",
                        text: props.borough.toUpperCase(),
                        yoffset: size * 0.8 + 15,
                        font: {
                            size: 13,
                            family: "'Source Sans 3', Arial, sans-serif",
                            weight: "bold"
                        }
                    }
                });
                window.boroughLabelsLayer.add(labelGraphic);
            });
        }

        // Load borough statistics
        async function loadBoroughStats() {
            try {
                const response = await fetch('/api/heatmap/boroughs');
                const data = await response.json();

                if (data.ok && data.boroughs) {
                    const container = document.getElementById('boroughStatsContainer');
                    container.innerHTML = data.boroughs.map(borough => `
                        <div class="borough-card" onclick="zoomToBorough('${borough.name}', ${borough.lat}, ${borough.lng})">
                            <div class="borough-header">
                                <span class="borough-name">${borough.name}</span>
                                <span class="risk-badge ${borough.risk_level.toLowerCase()}">${borough.risk_level}</span>
                            </div>
                            <div class="borough-complaints">${borough.complaint_count} complaints</div>
                            <div class="risk-bar-container">
                                <div class="risk-bar" style="width: ${borough.risk_score}%; background: ${
                                    borough.risk_level === 'High' ? 'linear-gradient(90deg, #ef4444, #dc2626)' : 
                                    borough.risk_level === 'Medium' ? 'linear-gradient(90deg, #fbbf24, #f59e0b)' : 
                                    'linear-gradient(90deg, #4ade80, #22c55e)'
                                };"></div>
                            </div>
                        </div>
                    `).join('');

                    const totalComplaints = data.boroughs.reduce((sum, b) => sum + b.complaint_count, 0);
                    const highestRisk = data.boroughs.reduce((a, b) => a.risk_score > b.risk_score ? a : b);
                    const lowestRisk = data.boroughs.reduce((a, b) => a.risk_score < b.risk_score ? a : b);

                    document.getElementById('summaryTotalComplaints').textContent = totalComplaints.toLocaleString();
                    document.getElementById('summaryHighestRisk').textContent = highestRisk.name;
                    document.getElementById('summaryLowestRisk').textContent = lowestRisk.name;
                }
            } catch (error) {
                console.error('Failed to load borough stats:', error);
            }
        }

        function updateHeatmapSummary(summary) {
            if (summary.total_complaints !== undefined) {
                document.getElementById('summaryTotalComplaints').textContent = summary.total_complaints.toLocaleString();
            }
        }

        function zoomToBorough(name, lat, lng) {
            if (heatmapView) {
                heatmapView.goTo({
                    center: [lng, lat],
                    zoom: 12
                }, { duration: 1000, easing: "ease-in-out" });
            }

            document.querySelectorAll('.borough-card').forEach(card => {
                card.classList.remove('selected');
                if (card.textContent.includes(name)) {
                    card.classList.add('selected');
                }
            });

            loadBoroughAnalysis(name);
        }

        async function loadBoroughAnalysis(borough) {
            const insightsDiv = document.getElementById('heatmapAIInsights');
            const textDiv = document.getElementById('heatmapAIText');
            
            insightsDiv.classList.add('active');
            textDiv.innerHTML = '<span style="color: var(--text-muted);">Loading AI analysis...</span>';

            try {
                const response = await fetch('/api/heatmap/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: `Analyze restaurant risks in ${borough}`,
                        borough: borough 
                    })
                });

                const data = await response.json();
                
                if (data.ok && data.analysis) {
                    let analysis = data.analysis;
                    if (analysis.length > 350) {
                        analysis = analysis.substring(0, 350) + '...';
                    }
                    textDiv.textContent = analysis;
                } else {
                    textDiv.textContent = 'Unable to load analysis for this borough.';
                }
            } catch (error) {
                console.error('Failed to load analysis:', error);
                textDiv.textContent = 'Error loading AI analysis.';
            }
        }

        applyHeatmapFiltersBtn.addEventListener('click', () => {
            const borough = heatmapBoroughFilter.value;
            loadHeatmapData(borough);
            
            if (borough && heatmapView) {
                const coords = {
                    'Manhattan': [-73.9712, 40.7831],
                    'Brooklyn': [-73.9442, 40.6782],
                    'Queens': [-73.7949, 40.7282],
                    'Bronx': [-73.8648, 40.8448],
                    'Staten Island': [-74.1502, 40.5795]
                };
                if (coords[borough]) {
                    heatmapView.goTo({
                        center: coords[borough],
                        zoom: 12
                    }, { duration: 800 });
                }
            }
        });

        resetHeatmapFiltersBtn.addEventListener('click', () => {
            heatmapBoroughFilter.value = '';
            loadHeatmapData();
            if (heatmapView) {
                heatmapView.goTo({
                    center: [-74.0060, 40.7128],
                    zoom: 10
                }, { duration: 800 });
            }
            document.querySelectorAll('.borough-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('heatmapAIInsights').classList.remove('active');
        });

        // Initialize
        updateSidebarStats();
        loadAgentStatus();
        setInterval(loadAgentStatus, 10000);


        // ========== ENHANCED FEATURES FOR FRIDAY DEMO ==========
        
        let currentViewMode = 'borough';
        const boroughDemographics = {
            'Manhattan': { population: '1.63M', income: '$93K', age: '37.8', density: '74,781' },
            'Brooklyn': { population: '2.70M', income: '$71K', age: '35.2', density: '37,137' },
            'Queens': { population: '2.29M', income: '$76K', age: '38.4', density: '21,460' },
            'Bronx': { population: '1.43M', income: '$45K', age: '34.3', density: '34,920' },
            'Staten Island': { population: '476K', income: '$87K', age: '40.1', density: '8,112' }
        };

        // Setup view toggle buttons
        function setupViewToggle() {
            const boroughViewBtn = document.getElementById('boroughViewBtn');
            const densityViewBtn = document.getElementById('densityViewBtn');

            if (!boroughViewBtn || !densityViewBtn) return;

            boroughViewBtn.addEventListener('click', () => {
                currentViewMode = 'borough';
                boroughViewBtn.classList.add('active');
                densityViewBtn.classList.remove('active');
                
                if (window.heatmapGraphicsLayer) window.heatmapGraphicsLayer.visible = true;
                if (window.boroughLabelsLayer) window.boroughLabelsLayer.visible = true;
                
                console.log("ðŸ“ Borough View active");
                showToast('Borough View activated', 'info');
            });

            densityViewBtn.addEventListener('click', () => {
                currentViewMode = 'density';
                densityViewBtn.classList.add('active');
                boroughViewBtn.classList.remove('active');
                
                alert('ðŸ”¥ Density Heatmap View!\n\nFull implementation shows 996 individual complaint points as a smooth heat gradient.\n\nThis demonstrates advanced geospatial visualization capabilities.');
                
                console.log("ðŸ”¥ Density Heatmap view");
            });
        }

        // Show infographics panel with demographics
        function showInfoPanel(boroughName) {
            const panel = document.getElementById('infographicsPanel');
            const demographics = boroughDemographics[boroughName];
            
            if (!demographics || !panel) return;
            
            document.getElementById('infoBoroughName').textContent = boroughName;
            document.getElementById('infoPop').textContent = demographics.population;
            document.getElementById('infoIncome').textContent = demographics.income;
            document.getElementById('infoAge').textContent = demographics.age;
            document.getElementById('infoDensity').textContent = demographics.density;
            
            panel.classList.add('visible');
            showToast('ðŸ“Š Demographics for ' + boroughName, 'success');
            console.log(`ðŸ“Š Showing demographics for ${boroughName}`);
        }

        // Close infographics panel
        function closeInfoPanel() {
            const panel = document.getElementById('infographicsPanel');
            if (panel) panel.classList.remove('visible');
        }

        // Toggle demographic layers
        function toggleDemographicLayer() {
            const checkbox = document.getElementById('incomeLayerToggle');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                if (checkbox.checked) {
                    console.log("ðŸ’° Income layer ON");
                    alert('ðŸ’° Demographic Layer: 2025 Median Household Income\n\nThis would overlay income data showing darker blue for higher income areas.\n\nFull implementation connects to ArcGIS demographic services.');
                } else {
                    console.log("ðŸ’° Income layer OFF");
                }
            }
        }

        function togglePopulationLayer() {
            const checkbox = document.getElementById('populationLayerToggle');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                if (checkbox.checked) {
                    console.log("ðŸ‘¥ Population layer ON");
                    alert('ðŸ‘¥ Demographic Layer: Population Density\n\nThis would show areas with higher population concentration.\n\nFull implementation uses ArcGIS population data.');
                } else {
                    console.log("ðŸ‘¥ Population layer OFF");
                }
            }
        }

        // Enhanced marker click handler for infographics
        function enhanceMarkerClickHandler() {
            if (heatmapView) {
                heatmapView.on("click", (event) => {
                    heatmapView.hitTest(event).then((response) => {
                        if (response.results.length > 0) {
                            const graphic = response.results[0].graphic;
                            if (graphic.attributes && graphic.attributes.borough) {
                                showInfoPanel(graphic.attributes.borough);
                            }
                        }
                    });
                });
            }
        }

        // Hook into heatmap initialization
        const originalInitHeatmap = initHeatmap;
        initHeatmap = function() {
            originalInitHeatmap();
            setTimeout(() => {
                setupViewToggle();
                enhanceMarkerClickHandler();
                console.log("âœ… Enhanced ArcGIS features initialized - Friday Demo Ready!");
                showToast('Enhanced features loaded! Try clicking a borough or toggling views.', 'success');
            }, 1000);
        };

        console.log("âœ… Enhanced features loaded - Friday Demo Package Ready! ðŸš€");

    </script>
</body>
</html>