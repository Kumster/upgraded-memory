<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Kitchen Compass AI - Multi-Agent System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Premium Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- ArcGIS CSS for Heatmap -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <style>
        /* ========== ROOT VARIABLES - MODERN PALETTE ========== */
        :root {
            --primary: #FF6B35;
            --primary-dark: #E85A2A;
            --primary-light: #FF8F66;
            --primary-glow: rgba(255, 107, 53, 0.4);
            
            --accent: #00D4AA;
            --accent-dark: #00B894;
            --accent-glow: rgba(0, 212, 170, 0.3);
            
            --dark-900: #0F172A;
            --dark-800: #1E293B;
            --dark-700: #334155;
            --dark-600: #475569;
            
            --light-100: #F8FAFC;
            --light-200: #E2E8F0;
            --light-300: #CBD5E1;
            
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.15);
            --shadow-glow: 0 0 40px var(--primary-glow);
        }

        /* ========== GLOBAL STYLES ========== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100vh;
            overflow: hidden;
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: var(--light-100);
            position: relative;
        }

        /* Animated Background Gradient */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(255, 107, 53, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 212, 170, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            animation: bgPulse 8s ease-in-out infinite;
        }

        @keyframes bgPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ========== MAIN CONTAINER ========== */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            padding: 1rem;
            gap: 1rem;
            position: relative;
            z-index: 1;
        }

        /* ========== GLASSMORPHISM SIDEBAR ========== */
        .sidebar {
            width: 300px;
            min-width: 300px;
            height: calc(100vh - 2rem);
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            flex-shrink: 0;
        }

        .sidebar.closed {
            width: 0;
            min-width: 0;
            padding: 0;
            margin: 0;
            opacity: 0;
            transform: translateX(-20px);
        }

        .sidebar-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            padding-right: 0.5rem;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        /* ========== STAT CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.15) 0%, rgba(255, 107, 53, 0.05) 100%);
            border-color: rgba(255, 107, 53, 0.3);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--light-100) 0%, var(--light-300) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.highlight .stat-value {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--light-300);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        /* ========== SECTION HEADERS ========== */
        .section-header {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--light-300);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 1.5rem 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
        }

        /* ========== AGENT STATUS LIST ========== */
        .agent-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .agent-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .agent-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .agent-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .agent-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.9); }
        }

        .agent-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: var(--light-300);
        }

        /* ========== TOPIC BUTTONS ========== */
        .topic-btn {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            font-size: 0.8rem;
            color: var(--light-100);
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .topic-btn:hover {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.15) 0%, rgba(255, 107, 53, 0.05) 100%);
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.2);
        }

        .topic-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        /* ========== QUICK LINKS ========== */
        .quick-link {
            display: block;
            font-size: 0.75rem;
            color: var(--accent);
            text-decoration: none;
            padding: 0.4rem 0;
            transition: all 0.2s ease;
        }

        .quick-link:hover {
            color: var(--light-100);
            transform: translateX(4px);
        }

        /* ========== CLEAR BUTTON ========== */
        .clear-btn {
            width: 100%;
            background: rgba(239, 68, 68, 0.1);
            color: #F87171;
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem);
            overflow: hidden;
            min-width: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ========== HEADER ========== */
        .header {
            text-align: center;
            padding: 0.75rem 0;
            flex-shrink: 0;
        }

        .header-content {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
        }

        .header h1 {
            font-size: clamp(1.75rem, 5vw, 3rem);
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            line-height: 1.1;
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: drop-shadow(0 0 20px var(--primary-glow)); }
            50% { filter: drop-shadow(0 0 30px var(--primary-glow)); }
        }

        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 0.4rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2rem;
            font-size: 0.75rem;
            color: var(--light-200);
        }

        .badge-dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* ========== CHAT CARD ========== */
        .chat-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            min-height: 0;
            margin-bottom: 0.75rem;
        }

        .chat-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 2rem;
            font-size: 0.75rem;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .chat-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .model-select {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: var(--light-100);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .model-select:hover {
            border-color: var(--primary);
        }

        .model-select option {
            background: var(--dark-800);
            color: var(--light-100);
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: var(--light-300);
            cursor: pointer;
        }

        .toggle-label input {
            accent-color: var(--primary);
        }

        .analytics-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .analytics-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--primary-glow);
        }

        /* ========== AGENT FLOW VISUALIZATION ========== */
        .agent-flow {
            padding: 1rem 1.25rem;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, rgba(255, 107, 53, 0.05) 100%);
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            display: none;
        }

        .agent-flow.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .agent-flow-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--warning);
        }

        .agent-flow-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-top-color: var(--warning);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .agent-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .agent-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .agent-indicator.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: var(--success);
        }

        .agent-indicator.active::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }

        .agent-indicator.waiting {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }

        .agent-indicator.complete {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: var(--info);
        }

        .agent-indicator.complete::before {
            content: '‚úì';
            font-size: 0.6rem;
        }

        /* ========== CHAT MESSAGES ========== */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
            min-height: 0;
            scroll-behavior: smooth;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .message {
            animation: messageIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 1rem;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .message.bot {
            display: flex;
            justify-content: flex-start;
        }

        .message-bubble {
            position: relative;
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: 1.25rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .message.bot .message-bubble {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--light-100);
            border-bottom-left-radius: 0.25rem;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            font-size: 10px;
            color: var(--light-300);
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0;
        }

        .message-bubble:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ========== TYPING INDICATOR ========== */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Loading dots */
        .loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* ========== SUGGESTED QUESTIONS ========== */
        .suggested-questions {
            padding: 0.75rem 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.2);
        }

        .suggested-btn {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 107, 53, 0.05) 100%);
            border: 1px solid rgba(255, 107, 53, 0.2);
            color: var(--light-100);
            padding: 0.6rem 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .suggested-btn:hover {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.2) 0%, rgba(255, 107, 53, 0.1) 100%);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.2);
        }

        /* ========== INPUT SECTION ========== */
        .input-section {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
            margin-bottom: 0.5rem;
        }

        .input-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .input-row input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            font-size: 0.9rem;
            color: var(--light-100);
            outline: none;
            transition: all 0.3s ease;
        }

        .input-row input::placeholder {
            color: var(--light-300);
        }

        .input-row input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--primary-glow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px var(--primary-glow);
        }

        .send-btn:active {
            transform: scale(0.98);
        }

        /* ========== UPLOAD SECTION ========== */
        .upload-section {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .upload-section label {
            font-size: 0.8rem;
            color: var(--light-300);
            font-weight: 500;
        }

        .upload-section input[type="file"] {
            font-size: 0.75rem;
            color: var(--light-300);
        }

        .upload-section input[type="file"]::file-selector-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--light-100);
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            margin-right: 0.75rem;
            transition: all 0.2s ease;
        }

        .upload-section input[type="file"]::file-selector-button:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .upload-btn {
            background: linear-gradient(135deg, var(--success) 0%, var(--accent-dark) 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        #uploadStatus {
            font-size: 0.75rem;
            color: var(--light-300);
        }

        /* ========== HAMBURGER BUTTON ========== */
        .hamburger-btn {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 200;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
            color: var(--primary);
            border: 1px solid rgba(255, 255, 255, 0.15);
            width: 44px;
            height: 44px;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hamburger-btn:hover {
            transform: scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.2);
        }

        /* ========== SIDEBAR OVERLAY ========== */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 99;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* ========== TOAST NOTIFICATIONS ========== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            color: white;
            font-weight: 500;
            font-size: 0.85rem;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100px) scale(0.9); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }

        .toast.success { 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%);
            border: 1px solid rgba(16, 185, 129, 0.5);
        }
        .toast.error { 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(220, 38, 38, 0.95) 100%);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        .toast.info { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(37, 99, 235, 0.95) 100%);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        .toast.warning { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.95) 0%, rgba(217, 119, 6, 0.95) 100%);
            border: 1px solid rgba(245, 158, 11, 0.5);
        }

        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 9998;
            overflow: hidden;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, var(--dark-800) 0%, var(--dark-900) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 1.5rem;
            animation: modalContentIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalContentIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--light-300);
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: var(--error);
        }

        /* Analytics Modal Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analytics-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .analytics-card .value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .analytics-card .label {
            font-size: 0.75rem;
            color: var(--light-300);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        /* ========== HEATMAP MODAL ========== */
        .heatmap-content {
            background: linear-gradient(135deg, var(--dark-800) 0%, var(--dark-900) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            max-width: 1200px;
            width: 100%;
            height: 90vh;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: modalContentIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .heatmap-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .heatmap-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .heatmap-header p {
            margin: 0.25rem 0 0;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .heatmap-filters {
            padding: 1rem 1.25rem;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.8rem;
            color: var(--light-300);
            font-weight: 500;
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: var(--light-100);
            cursor: pointer;
        }

        .filter-select option {
            background: var(--dark-800);
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .filter-btn.primary:hover {
            transform: translateY(-2px);
        }

        .filter-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light-300);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .filter-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .heatmap-body {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
            min-height: 0;
        }

        .heatmap-map-container {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #heatmapViewDiv {
            flex: 1;
            border-radius: 1rem;
            min-height: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .legend-title {
            font-weight: 600;
            color: var(--light-100);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--light-300);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .legend-dot.high { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .legend-dot.medium { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .legend-dot.low { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); }

        .heatmap-stats {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow-y: auto;
            min-height: 0;
            padding-right: 0.5rem;
        }

        .heatmap-stats::-webkit-scrollbar {
            width: 4px;
        }
        .heatmap-stats::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .stats-section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--light-100);
            margin: 0 0 0.25rem;
        }

        .stats-section-desc {
            font-size: 0.75rem;
            color: var(--light-300);
            margin: 0 0 0.75rem;
        }

        .borough-card {
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .borough-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
        }

        .borough-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.15) 0%, rgba(255, 107, 53, 0.05) 100%);
        }

        .borough-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .borough-name {
            font-weight: 600;
            color: var(--light-100);
        }

        .risk-badge {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            border-radius: 2rem;
            font-weight: 600;
        }

        .risk-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: #F87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .risk-badge.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #FBBF24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .risk-badge.low {
            background: rgba(16, 185, 129, 0.2);
            color: #34D399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .borough-complaints {
            font-size: 0.8rem;
            color: var(--light-300);
            margin-bottom: 0.5rem;
        }

        .risk-bar-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .risk-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.8s ease;
        }

        .summary-card {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 107, 53, 0.05) 100%);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 1rem;
            padding: 1rem;
        }

        .summary-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 0.75rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .summary-row:last-child {
            margin-bottom: 0;
        }

        .summary-row .label {
            color: var(--light-300);
        }

        .summary-row .value {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .ai-insights-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 1rem;
            padding: 1rem;
            display: none;
        }

        .ai-insights-card.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .ai-insights-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--info);
            margin: 0 0 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-insights-text {
            font-size: 0.85rem;
            color: var(--light-200);
            line-height: 1.6;
        }

        /* ========== FORMATTED RESPONSE STYLES ========== */
        .message-bubble h1, .message-bubble h2, .message-bubble h3, .message-bubble h4 {
            color: var(--primary);
            margin: 1em 0 0.5em;
            font-weight: 700;
        }

        .message-bubble h1:first-child, .message-bubble h2:first-child, 
        .message-bubble h3:first-child, .message-bubble h4:first-child {
            margin-top: 0;
        }

        .message-bubble strong {
            color: var(--primary-light);
        }

        .message-bubble ul, .message-bubble ol {
            padding-left: 1.5rem;
            margin: 0.5em 0;
        }

        .message-bubble li {
            margin-bottom: 0.25em;
        }

        .message-bubble code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
        }

        .message-bubble pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.75em 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-bubble pre code {
            background: transparent;
            padding: 0;
        }

        .message-bubble table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75em 0;
            font-size: 0.85em;
        }

        .message-bubble th {
            background: var(--primary);
            color: white;
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .message-bubble td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-bubble tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .pro-tip {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
            border-left: 3px solid var(--warning);
            padding: 0.75rem 1rem;
            margin: 0.75em 0;
            border-radius: 0 0.5rem 0.5rem 0;
            font-size: 0.85em;
        }

        .source-citation {
            color: var(--light-300);
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }

        .source-legend {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.75rem;
            color: var(--light-300);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1024px) {
            .app-container {
                padding: 0.75rem;
                gap: 0.75rem;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                border-radius: 0 1.5rem 1.5rem 0;
                z-index: 1000;
            }

            .sidebar.closed {
                transform: translateX(-100%);
                width: 300px;
            }

            .heatmap-body {
                grid-template-columns: 1fr;
            }

            .heatmap-stats {
                max-height: 200px;
            }
        }

        @media (max-width: 640px) {
            .app-container {
                padding: 0.5rem;
            }

            .suggested-questions {
                grid-template-columns: 1fr;
            }

            .heatmap-content {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }

            .chat-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .chat-controls {
                width: 100%;
                justify-content: flex-start;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu Button -->
    <button id="hamburgerBtn" class="hamburger-btn" aria-label="Toggle sidebar">‚ò∞</button>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-content">
                <!-- Sidebar Header -->
                <div class="sidebar-header">
                    <div class="sidebar-logo">üç≥</div>
                    <div>
                        <div class="sidebar-title">Kitchen Compass</div>
                        <div style="font-size: 0.7rem; color: var(--light-300);">v2.0 Multi-Agent</div>
                    </div>
                </div>

                <div class="sidebar-scroll">
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card highlight">
                            <div class="stat-value" id="sidebarDocs">5000</div>
                            <div class="stat-label">Documents</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="sidebarQuestions">0</div>
                            <div class="stat-label">Questions</div>
                        </div>
                        <div class="stat-card" style="grid-column: span 2;">
                            <div class="stat-value" id="sidebarAvgTime">0s</div>
                            <div class="stat-label">Avg Response Time</div>
                        </div>
                    </div>

                    <!-- Agent Status -->
                    <div class="section-header">ü§ñ AI Agents</div>
                    <div class="agent-list" id="agentStatusList">
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Intent Router</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Complaint Analyzer</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Compliance Guide</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Location Risk</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Strategic Advisor</span>
                            <span class="agent-count">0</span>
                        </div>
                        <div class="agent-item">
                            <span class="agent-name"><span class="agent-dot"></span>Violation Prevention</span>
                            <span class="agent-count">0</span>
                        </div>
                    </div>

                    <!-- Popular Topics -->
                    <div class="section-header">üéØ Quick Actions</div>
                    <button class="topic-btn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);">üìã</div>
                        <span>Permits & Licenses</span>
                    </button>
                    <button class="topic-btn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">üè•</div>
                        <span>Health Inspections</span>
                    </button>
                    <button class="topic-btn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);">üìç</div>
                        <span>Location Analysis</span>
                    </button>
                    <button class="topic-btn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">‚ö†Ô∏è</div>
                        <span>Common Violations</span>
                    </button>
                    <button class="topic-btn" id="heatmapBtn">
                        <div class="topic-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">üó∫Ô∏è</div>
                        <span>Risk Heatmap</span>
                    </button>

                    <!-- Quick Links -->
                    <div class="section-header">üîó Resources</div>
                    <a href="https://www1.nyc.gov/nycbusiness/description/food-service-establishment-permit" target="_blank" class="quick-link">‚Üí NYC Food Permits</a>
                    <a href="https://www1.nyc.gov/site/doh/index.page" target="_blank" class="quick-link">‚Üí NYC Health Dept</a>
                    <a href="https://www1.nyc.gov/site/sbs/index.page" target="_blank" class="quick-link">‚Üí Small Business Services</a>

                    <!-- Clear History -->
                    <button id="clearHistory" class="clear-btn">üóëÔ∏è Clear Chat History</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <h1>KITCHEN COMPASS AI</h1>
                    <div class="header-badge">
                        <span class="badge-dot"></span>
                        <span>Multi-Agent System for NYC Restaurant Entrepreneurs</span>
                    </div>
                </div>
            </div>

            <!-- Chat Card -->
            <div class="chat-card">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-status">
                        <div class="status-indicator">
                            <span class="status-dot"></span>
                            <span>Online</span>
                        </div>
                        <span style="font-size: 0.75rem; color: var(--light-300);">Kitchen Compass AI v2.0</span>
                    </div>
                    <div class="chat-controls">
                        <select id="modelSelector" class="model-select">
                            <option value="gpt-4o-mini" selected>ü§ñ GPT-4o-mini</option>
                            <option value="ollama">ü¶ô Ollama</option>
                        </select>
                        <label class="toggle-label">
                            <input type="checkbox" id="streamToggle">
                            <span>Stream</span>
                        </label>
                        <button id="showAnalytics" class="analytics-btn">üìä Analytics</button>
                    </div>
                </div>

                <!-- Agent Flow Visualization -->
                <div id="agentFlow" class="agent-flow">
                    <div class="agent-flow-header">
                        <div class="agent-flow-spinner"></div>
                        <span>Agent Execution Flow</span>
                    </div>
                    <div id="agentIndicators" class="agent-indicators"></div>
                </div>

                <!-- Chat Messages -->
                <div id="chatContainer" class="chat-container">
                    <div class="message bot">
                        <div class="message-bubble">
                            <p style="margin: 0 0 1rem 0;">
                                <strong style="font-size: 1.1em;">üëã Welcome to Kitchen Compass AI!</strong><br>
                                <span style="color: var(--light-300);">Your NYC restaurant setup copilot powered by 6 specialized AI agents.</span>
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin: 1rem 0;">
                                <div style="padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 0.5rem; font-size: 0.8rem;">
                                    üß≠ <strong>Intent Router</strong><br>
                                    <span style="color: var(--light-300);">Smart query routing</span>
                                </div>
                                <div style="padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 0.5rem; font-size: 0.8rem;">
                                    üìä <strong>Complaint Analyzer</strong><br>
                                    <span style="color: var(--light-300);">311 data insights</span>
                                </div>
                                <div style="padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 0.5rem; font-size: 0.8rem;">
                                    ‚úÖ <strong>Compliance Guide</strong><br>
                                    <span style="color: var(--light-300);">Health code expert</span>
                                </div>
                                <div style="padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 0.5rem; font-size: 0.8rem;">
                                    üìç <strong>Location Risk</strong><br>
                                    <span style="color: var(--light-300);">Neighborhood analysis</span>
                                </div>
                                <div style="padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 0.5rem; font-size: 0.8rem;">
                                    üí° <strong>Strategic Advisor</strong><br>
                                    <span style="color: var(--light-300);">Business strategy</span>
                                </div>
                                <div style="padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 0.5rem; font-size: 0.8rem;">
                                    üõ°Ô∏è <strong>Violation Prevention</strong><br>
                                    <span style="color: var(--light-300);">Proactive compliance</span>
                                </div>
                            </div>
                            <p style="margin: 0; padding: 0.75rem; background: linear-gradient(135deg, rgba(255, 107, 53, 0.15) 0%, rgba(255, 107, 53, 0.05) 100%); border-radius: 0.5rem; font-size: 0.85rem;">
                                üí° <strong>Try:</strong> "Show me a heatmap of restaurant risks" or "What permits do I need?"
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Suggested Questions -->
                <div class="suggested-questions">
                    <button class="suggested-btn">What permits do I need to open a restaurant?</button>
                    <button class="suggested-btn">Show me a heatmap of NYC restaurant risks</button>
                    <button class="suggested-btn">What are the most common health violations?</button>
                    <button class="suggested-btn">Which neighborhood is safest for restaurants?</button>
                </div>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div class="input-row">
                    <input 
                        type="text" 
                        id="userInput" 
                        placeholder="Ask about permits, inspections, locations, violations, or business strategy..."
                    />
                    <button id="sendBtn" class="send-btn">‚ñ∂</button>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="upload-section">
                <label>üìÅ Upload NYC Data (CSV):</label>
                <input type="file" id="csvFile" accept=".csv" />
                <button id="uploadBtn" class="upload-btn">Upload & Ingest</button>
                <span id="uploadStatus"></span>
            </div>
        </main>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä System Analytics & Agent Performance</h2>
                <button id="closeAnalytics" class="modal-close">√ó</button>
            </div>
            <div id="analyticsContent">
                <p style="color: var(--light-300);">Loading analytics...</p>
            </div>
        </div>
    </div>

    <!-- Heatmap Modal -->
    <div id="heatmapModal" class="modal">
        <div class="heatmap-content">
            <!-- Header -->
            <div class="heatmap-header">
                <div>
                    <h2>üó∫Ô∏è NYC Restaurant Risk Heatmap</h2>
                    <p>Interactive visualization of complaint density by borough</p>
                </div>
                <button id="closeHeatmapModal" class="modal-close" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">√ó</button>
            </div>
            
            <!-- Filters -->
            <div class="heatmap-filters">
                <div class="filter-group">
                    <label>Filter by Borough:</label>
                    <select id="heatmapBoroughFilter" class="filter-select">
                        <option value="">üèôÔ∏è All Boroughs</option>
                        <option value="Manhattan">üè¢ Manhattan</option>
                        <option value="Brooklyn">üåâ Brooklyn</option>
                        <option value="Queens">üëë Queens</option>
                        <option value="Bronx">ü¶Å Bronx</option>
                        <option value="Staten Island">üèùÔ∏è Staten Island</option>
                    </select>
                </div>
                <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                    <button id="applyHeatmapFilters" class="filter-btn primary">Apply Filter</button>
                    <button id="resetHeatmapFilters" class="filter-btn secondary">Reset</button>
                </div>
            </div>
            
            <!-- Map and Stats -->
            <div class="heatmap-body">
                <!-- Map Container -->
                <div class="heatmap-map-container">
                    <div id="heatmapViewDiv"></div>
                    
                    <!-- Legend -->
                    <div class="heatmap-legend">
                        <span class="legend-title">Risk Level:</span>
                        <div class="legend-item">
                            <div class="legend-dot high"></div>
                            <span>High (70+)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot medium"></div>
                            <span>Medium (40-69)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot low"></div>
                            <span>Low (0-39)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Sidebar -->
                <div class="heatmap-stats">
                    <h3 class="stats-section-title">üìä Borough Statistics</h3>
                    <p class="stats-section-desc">Click a borough to zoom and see AI insights</p>
                    <div id="boroughStatsContainer"></div>
                    
                    <!-- Summary -->
                    <div class="summary-card">
                        <h4 class="summary-title">üìà Summary</h4>
                        <div class="summary-row">
                            <span class="label">Total Complaints:</span>
                            <span class="value" id="summaryTotalComplaints" style="color: var(--light-100);">0</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Highest Risk:</span>
                            <span class="value" id="summaryHighestRisk" style="color: #F87171;">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Lowest Risk:</span>
                            <span class="value" id="summaryLowestRisk" style="color: #34D399;">-</span>
                        </div>
                    </div>
                    
                    <!-- AI Insights -->
                    <div id="heatmapAIInsights" class="ai-insights-card">
                        <h4 class="ai-insights-title">ü§ñ AI Insights</h4>
                        <p id="heatmapAIText" class="ai-insights-text"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ArcGIS API -->
    <script src="https://js.arcgis.com/4.28/"></script>

    <script>
        // ========== EXACT SAME JAVASCRIPT AS ORIGINAL ==========
        // (Copy your entire JavaScript section here - it's unchanged)
        // I'm keeping it identical to preserve all functionality
        
        // Global Variables
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const modelSelector = document.getElementById('modelSelector');
        const streamToggle = document.getElementById('streamToggle');
        const suggestedBtns = document.querySelectorAll('.suggested-btn');
        const uploadBtn = document.getElementById('uploadBtn');
        const csvFile = document.getElementById('csvFile');
        const uploadStatus = document.getElementById('uploadStatus');
        const showAnalyticsBtn = document.getElementById('showAnalytics');
        const analyticsModal = document.getElementById('analyticsModal');
        const closeAnalyticsBtn = document.getElementById('closeAnalytics');
        const analyticsContent = document.getElementById('analyticsContent');
        const clearHistoryBtn = document.getElementById('clearHistory');
        const topicBtns = document.querySelectorAll('.topic-btn');
        const agentFlow = document.getElementById('agentFlow');
        const agentIndicators = document.getElementById('agentIndicators');
        const agentStatusList = document.getElementById('agentStatusList');

        let questionCount = 0;
        let totalResponseTime = 0;

        // Heatmap variables
        let heatmapView = null;
        let heatmapGraphicsLayer = null;
        let heatmapLabelsLayer = null;
        let ArcGISGraphic = null;

        // Heatmap trigger patterns
        const heatmapTriggerPatterns = [
            'heatmap', 'heat map', 'show map', 'show me a map', 
            'risk map', 'complaint map', 'visualize', 'visualization',
            'where should i open', 'safest neighborhood', 'safest borough',
            'highest risk', 'lowest risk', 'complaint hotspot', 'hotspot',
            'map of complaints', 'map of risks', 'show risk', 'show risks',
            'which area', 'which neighborhood', 'which borough is safest',
            'dangerous area', 'safe area', 'compare boroughs', 'borough comparison'
        ];

        function shouldTriggerHeatmap(message) {
            const lowerMessage = message.toLowerCase();
            return heatmapTriggerPatterns.some(pattern => lowerMessage.includes(pattern));
        }

        // Sidebar Toggle
        const sidebar = document.getElementById('sidebar');
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function openSidebar() {
            sidebar.classList.remove('closed');
            sidebarOverlay.classList.add('active');
            if (window.innerWidth < 1024) {
                document.body.style.overflow = 'hidden';
            }
            localStorage.setItem('sidebarOpen', 'true');
        }

        function closeSidebar() {
            sidebar.classList.add('closed');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
            localStorage.setItem('sidebarOpen', 'false');
        }

        function toggleSidebar() {
            if (sidebar.classList.contains('closed')) {
                openSidebar();
            } else {
                closeSidebar();
            }
        }

        hamburgerBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        function loadSidebarState() {
            const isDesktop = window.innerWidth >= 1024;
            const savedState = localStorage.getItem('sidebarOpen');
            
            if (isDesktop) {
                const shouldBeOpen = savedState !== 'false';
                if (shouldBeOpen) {
                    openSidebar();
                    sidebarOverlay.classList.remove('active');
                } else {
                    closeSidebar();
                }
            } else {
                closeSidebar();
            }
        }

        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        loadSidebarState();

        // Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Agent Status
        async function loadAgentStatus() {
            try {
                const response = await fetch('/api/agents/status');
                const data = await response.json();

                if (data.ok && data.agents) {
                    updateAgentStatusSidebar(data.agents);
                }
            } catch (error) {
                console.error('Failed to load agent status:', error);
            }
        }

        function updateAgentStatusSidebar(agents) {
            agentStatusList.innerHTML = agents.map(agent => `
                <div class="agent-item">
                    <span class="agent-name"><span class="agent-dot"></span>${agent.name}</span>
                    <span class="agent-count">${agent.usage_count || 0}</span>
                </div>
            `).join('');
        }

        function showAgentIndicator(agentName, status = 'active') {
            const indicator = document.createElement('div');
            indicator.className = `agent-indicator ${status}`;
            indicator.id = `agent-${agentName}`;
            indicator.innerHTML = `<span>${agentName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>`;
            agentIndicators.appendChild(indicator);
            agentFlow.classList.add('active');
        }

        function updateAgentIndicator(agentName, status) {
            const indicator = document.getElementById(`agent-${agentName}`);
            if (indicator) {
                indicator.className = `agent-indicator ${status}`;
            }
        }

        function clearAgentIndicators() {
            agentIndicators.innerHTML = '';
            agentFlow.classList.remove('active');
        }

        // Stats Update
        function updateSidebarStats() {
            document.getElementById('sidebarQuestions').textContent = questionCount;
            const avgTime = questionCount > 0 ? (totalResponseTime / questionCount).toFixed(1) : 0;
            document.getElementById('sidebarAvgTime').textContent = avgTime + 's';
        }

        // Topic Buttons
        topicBtns.forEach(btn => {
            if (btn.id !== 'heatmapBtn') {
                btn.addEventListener('click', () => {
                    const topic = btn.querySelector('span').textContent.trim();
                    userInput.value = `Tell me about ${topic}`;
                    sendMessage();
                    
                    if (window.innerWidth < 1024) {
                        closeSidebar();
                    }
                });
            }
        });

        // Clear History
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the chat history?')) {
                chatContainer.innerHTML = '';
                questionCount = 0;
                totalResponseTime = 0;
                updateSidebarStats();
                showToast('Chat history cleared', 'success');
            }
        });

        // Suggested Questions
        suggestedBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.textContent.trim();
                userInput.value = question;
                sendMessage();
            });
        });

        // Send Message
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            questionCount++;
            updateSidebarStats();

            const selectedModel = modelSelector.value;
            const modelName = selectedModel === 'gpt-4o-mini' ? 'GPT-4o-mini' : 'Ollama';
            const useStreaming = streamToggle.checked;

            displayMessage(message, 'user');
            userInput.value = '';

            clearAgentIndicators();

            if (shouldTriggerHeatmap(message)) {
                displayMessage('üó∫Ô∏è Opening the NYC Restaurant Risk Heatmap for you! This interactive visualization shows complaint density and risk levels across all five boroughs.', 'bot');
                showToast('Opening Risk Heatmap...', 'info');
                
                setTimeout(() => {
                    openHeatmapModal();
                }, 500);
                
                generateResponse(message, selectedModel, modelName);
            } else if (useStreaming) {
                await streamResponse(message, selectedModel);
            } else {
                await generateResponse(message, selectedModel, modelName);
            }

            loadAgentStatus();
        }

        // Non-Streaming Response
        async function generateResponse(message, model, modelName) {
            const loadingId = displayMessage(`ü§ñ Thinking (${modelName})<span class="loading-dots"></span>`, 'bot', true);

            const startTime = Date.now();

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: message,
                        model: model,
                        stream: false
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId)?.remove();

                const executionTime = (Date.now() - startTime) / 1000;
                totalResponseTime += executionTime;
                updateSidebarStats();

                if (data.ok) {
                    let responseText = data.output;
                    
                    if (typeof responseText === 'object' && responseText !== null) {
                        responseText = responseText.text || responseText.content || JSON.stringify(responseText);
                    }
                    
                    displayMessage(responseText, 'bot');
                    showToast(`Response generated in ${executionTime.toFixed(1)}s`, 'success');
                } else {
                    displayMessage('Sorry, something went wrong. Please try again.', 'bot');
                    showToast('Failed to generate response', 'error');
                }
            } catch (error) {
                document.getElementById(loadingId)?.remove();
                displayMessage('Error connecting to server. Please try again.', 'bot');
                showToast('Connection error', 'error');
                console.error('Error:', error);
            }
        }

        // Streaming Response
        async function streamResponse(message, model) {
            const messageId = displayMessage('', 'bot', false, true);
            const messageBubble = document.getElementById(messageId).querySelector('.message-content');

            showAgentIndicator('intent_router', 'active');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: message,
                        model: model,
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let content = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'agent') {
                                    if (data.status === 'active') {
                                        showAgentIndicator(data.agent.toLowerCase().replace(/ /g, '_'), 'active');
                                    } else if (data.status === 'complete') {
                                        updateAgentIndicator(data.agent.toLowerCase().replace(/ /g, '_'), 'complete');
                                    }
                                } else if (data.type === 'content') {
                                    content += data.content;
                                    messageBubble.innerHTML = formatBotResponse(content);
                                } else if (data.type === 'done') {
                                    showToast('Response complete', 'success');
                                } else if (data.type === 'error') {
                                    showToast('Error: ' + data.error, 'error');
                                }
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }

                chatContainer.scrollTop = chatContainer.scrollHeight;
            } catch (error) {
                showToast('Streaming error', 'error');
                console.error('Streaming error:', error);
            }
        }

        // Display Message
        function displayMessage(text, sender, isLoading = false, isStreaming = false) {
            const messageDiv = document.createElement('div');
            const id = 'msg-' + Date.now();
            messageDiv.id = id;
            messageDiv.className = `message ${sender}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            if (sender === 'bot' && !isLoading && !isStreaming) {
                text = formatBotResponse(text);
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'üìã Copy';
                copyBtn.onclick = () => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = text;
                    navigator.clipboard.writeText(tempDiv.textContent);
                    copyBtn.textContent = '‚úÖ Copied!';
                    setTimeout(() => copyBtn.textContent = 'üìã Copy', 2000);
                };
                bubble.appendChild(copyBtn);
            }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = text;
            bubble.appendChild(content);
            
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return id;
        }

        // Format Bot Response
        function formatBotResponse(text) {
            if (typeof text !== 'string') {
                text = String(text);
            }
            
            text = text.replace(/^#{1,4}\s+(.+)$/gm, '<div style="font-weight: 700; color: var(--primary); margin: 0.8em 0 0.4em 0; font-size: 1em;">$1</div>');
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/^[\-\‚Ä¢\*]\s+(.+)$/gm, '<div style="margin: 0.3em 0 0.3em 0.8em; padding-left: 0.6em; border-left: 2px solid var(--primary);">$1</div>');
            text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin: 0.3em 0 0.3em 0.8em;"><span style="color: var(--primary); font-weight: 600;">$1.</span> $2</div>');
            text = text.replace(/üí°\s*Pro Tip:?\s*(.+?)(?=\n\n|$)/gs, '<div class="pro-tip">üí° <strong>Pro Tip:</strong> $1</div>');
            text = text.replace(/\[Source\s*(\d+)\]/g, '<span class="source-citation">[Source $1]</span>');
            text = text.replace(/---\nüìö Sources:/g, '<div class="source-legend">üìö <strong>Sources:</strong></div>');
            text = text.replace(/\n\n/g, '<br><br>');
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        // CSV Upload
        uploadBtn.addEventListener('click', async () => {
            const file = csvFile.files[0];
            if (!file) {
                showToast('Please select a CSV file first', 'warning');
                uploadStatus.textContent = '‚ö†Ô∏è Please select a CSV file first.';
                uploadStatus.style.color = '#F59E0B';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            uploadStatus.textContent = '‚è≥ Uploading and processing...';
            uploadStatus.style.color = '#3B82F6';

            try {
                const response = await fetch('/api/ingest_csv', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.ok) {
                    uploadStatus.textContent = `‚úÖ Success! Ingested ${data.rows_ingested || 0} rows. Vector store has ${data.total_chunks || 0} chunks.`;
                    uploadStatus.style.color = '#10B981';
                    document.getElementById('sidebarDocs').textContent = data.total_chunks || 0;
                    showToast(`Successfully ingested ${data.rows_ingested} rows`, 'success');
                } else {
                    uploadStatus.textContent = '‚ùå Upload failed. Please try again.';
                    uploadStatus.style.color = '#EF4444';
                    showToast('Upload failed', 'error');
                }
            } catch (error) {
                uploadStatus.textContent = '‚ùå Error uploading file.';
                uploadStatus.style.color = '#EF4444';
                showToast('Upload error', 'error');
                console.error('Upload error:', error);
            }
        });

        // Analytics Modal
        showAnalyticsBtn.addEventListener('click', async () => {
            analyticsModal.classList.add('active');
            analyticsContent.innerHTML = '<p style="color: var(--light-300);">Loading analytics...</p>';

            try {
                const response = await fetch('/api/analytics/overview');
                const data = await response.json();

                if (data.ok) {
                    const currentModel = modelSelector.options[modelSelector.selectedIndex].text;
                    
                    let agentUsageHTML = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">';
                    if (data.overview.agent_usage && Object.keys(data.overview.agent_usage).length > 0) {
                        for (const [agent, count] of Object.entries(data.overview.agent_usage)) {
                            agentUsageHTML += `
                                <div class="analytics-card">
                                    <div class="value">${count}</div>
                                    <div class="label">${agent.replace(/_/g, ' ')}</div>
                                </div>
                            `;
                        }
                    } else {
                        agentUsageHTML += '<p style="grid-column: span 3; color: var(--light-300); text-align: center;">No agent usage data yet</p>';
                    }
                    agentUsageHTML += '</div>';

                    analyticsContent.innerHTML = `
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <div class="value">${data.overview.total_chunks || 0}</div>
                                <div class="label">Vector Store Chunks</div>
                            </div>
                            <div class="analytics-card">
                                <div class="value">${data.overview.total_queries || 0}</div>
                                <div class="label">Queries Processed</div>
                            </div>
                            <div class="analytics-card">
                                <div class="value">${data.overview.avg_execution_time || 0}s</div>
                                <div class="label">Avg Execution Time</div>
                            </div>
                            <div class="analytics-card">
                                <div class="value" style="font-size: 1rem;">${currentModel}</div>
                                <div class="label">Current Model</div>
                            </div>
                        </div>
                        
                        <h3 style="color: var(--light-100); margin-bottom: 1rem; font-size: 1rem;">Agent Usage Statistics</h3>
                        ${agentUsageHTML}

                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 0.75rem; margin-top: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <p style="margin: 0; color: var(--light-200);"><strong>System Status:</strong> ${data.overview.total_chunks > 0 ? '‚úÖ Operational with data' : '‚ö†Ô∏è No data ingested yet'}</p>
                            <p style="margin: 0.5rem 0 0 0; color: var(--light-300); font-size: 0.85rem;"><strong>Tip:</strong> Upload NYC restaurant inspection data (CSV) to enhance insights!</p>
                        </div>
                    `;
                    
                    document.getElementById('sidebarDocs').textContent = data.overview.total_chunks || 0;
                } else {
                    analyticsContent.innerHTML = '<p style="color: #EF4444;">Failed to load analytics.</p>';
                }
            } catch (error) {
                analyticsContent.innerHTML = '<p style="color: #EF4444;">Error loading analytics.</p>';
                console.error('Analytics error:', error);
            }
        });

        closeAnalyticsBtn.addEventListener('click', () => {
            analyticsModal.classList.remove('active');
        });

        analyticsModal.addEventListener('click', (e) => {
            if (e.target === analyticsModal) {
                analyticsModal.classList.remove('active');
            }
        });

        // Heatmap Functions
        const heatmapModal = document.getElementById('heatmapModal');
        const heatmapBtn = document.getElementById('heatmapBtn');
        const closeHeatmapBtn = document.getElementById('closeHeatmapModal');
        const applyHeatmapFiltersBtn = document.getElementById('applyHeatmapFilters');
        const resetHeatmapFiltersBtn = document.getElementById('resetHeatmapFilters');
        const heatmapBoroughFilter = document.getElementById('heatmapBoroughFilter');

        function openHeatmapModal() {
            heatmapModal.classList.add('active');
            if (window.innerWidth < 1024) {
                closeSidebar();
            }
            setTimeout(() => {
                initHeatmap();
            }, 100);
        }

        heatmapBtn.addEventListener('click', openHeatmapModal);

        closeHeatmapBtn.addEventListener('click', () => {
            heatmapModal.classList.remove('active');
        });

        heatmapModal.addEventListener('click', (e) => {
            if (e.target === heatmapModal) {
                heatmapModal.classList.remove('active');
            }
        });

        // Initialize ArcGIS Heatmap
        function initHeatmap() {
            if (heatmapView) {
                loadHeatmapData();
                loadBoroughStats();
                return;
            }

            require([
                "esri/Map",
                "esri/views/MapView",
                "esri/layers/GraphicsLayer",
                "esri/Graphic"
            ], function(Map, MapView, GraphicsLayer, Graphic) {
                
                window.ArcGISGraphic = Graphic;
                
                const map = new Map({
                    basemap: "dark-gray-vector"
                });

                heatmapGraphicsLayer = new GraphicsLayer();
                heatmapLabelsLayer = new GraphicsLayer();
                map.add(heatmapGraphicsLayer);
                map.add(heatmapLabelsLayer);

                heatmapView = new MapView({
                    container: "heatmapViewDiv",
                    map: map,
                    center: [-74.0060, 40.7128],
                    zoom: 10,
                    ui: {
                        components: ["zoom", "compass"]
                    }
                });

                heatmapView.when(() => {
                    console.log("‚úÖ ArcGIS Map initialized successfully");
                    loadHeatmapData();
                    loadBoroughStats();
                });
            });
        }

        // Load heatmap data
        async function loadHeatmapData(borough = '') {
            const sampleData = {
                ok: true,
                features: [
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-73.9712, 40.7831] },
                        properties: { borough: "Manhattan", complaint_count: 245, risk_score: 72, risk_level: "High" }
                    },
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-73.9442, 40.6782] },
                        properties: { borough: "Brooklyn", complaint_count: 312, risk_score: 78, risk_level: "High" }
                    },
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-73.7949, 40.7282] },
                        properties: { borough: "Queens", complaint_count: 189, risk_score: 65, risk_level: "Medium" }
                    },
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-73.8648, 40.8448] },
                        properties: { borough: "Bronx", complaint_count: 156, risk_score: 61, risk_level: "Medium" }
                    },
                    {
                        type: "Feature",
                        geometry: { type: "Point", coordinates: [-74.1502, 40.5795] },
                        properties: { borough: "Staten Island", complaint_count: 67, risk_score: 42, risk_level: "Low" }
                    }
                ],
                summary: {
                    total_complaints: 969,
                    highest_risk: "Brooklyn",
                    lowest_risk: "Staten Island"
                }
            };

            try {
                let url = '/api/heatmap/data';
                if (borough) {
                    url += `?borough=${encodeURIComponent(borough)}`;
                }

                console.log("üì° Fetching heatmap data from:", url);
                const response = await fetch(url);
                const data = await response.json();
                
                console.log("üìä Heatmap API response:", data);

                if (data.ok && data.features && data.features.length > 0) {
                    let features = data.features;
                    if (borough) {
                        features = features.filter(f => 
                            f.properties.borough.toLowerCase() === borough.toLowerCase()
                        );
                    }
                    addMarkersToMap(features);
                    if (data.summary) {
                        updateHeatmapSummary(data.summary);
                    }
                    showToast(`Loaded ${features.length} borough markers`, 'success');
                } else {
                    console.warn("API returned no data, using fallback sample data");
                    let features = sampleData.features;
                    if (borough) {
                        features = features.filter(f => 
                            f.properties.borough.toLowerCase() === borough.toLowerCase()
                        );
                    }
                    addMarkersToMap(features);
                    updateHeatmapSummary(sampleData.summary);
                    showToast(`Loaded ${features.length} sample markers`, 'info');
                }
            } catch (error) {
                console.error('API failed, using fallback sample data:', error);
                let features = sampleData.features;
                if (borough) {
                    features = features.filter(f => 
                        f.properties.borough.toLowerCase() === borough.toLowerCase()
                    );
                }
                addMarkersToMap(features);
                updateHeatmapSummary(sampleData.summary);
                showToast('Using sample data', 'info');
            }
        }

        // Add markers to map
        function addMarkersToMap(features) {
            if (!heatmapGraphicsLayer || !heatmapLabelsLayer || !window.ArcGISGraphic) {
                console.error("ArcGIS not initialized yet, retrying in 500ms...");
                setTimeout(() => addMarkersToMap(features), 500);
                return;
            }

            console.log("üéØ Adding", features.length, "markers to map");
            
            heatmapGraphicsLayer.removeAll();
            heatmapLabelsLayer.removeAll();

            features.forEach(feature => {
                const props = feature.properties;
                const coords = feature.geometry.coordinates;
                
                console.log("‚úì Adding:", props.borough, "at", coords);
                
                let color, outlineColor;
                if (props.risk_score >= 70) {
                    color = [239, 68, 68, 0.85];
                    outlineColor = [185, 28, 28, 1];
                } else if (props.risk_score >= 40) {
                    color = [251, 191, 36, 0.85];
                    outlineColor = [217, 119, 6, 1];
                } else {
                    color = [74, 222, 128, 0.85];
                    outlineColor = [22, 163, 74, 1];
                }

                const baseSize = 45;
                const size = Math.min(80, Math.max(baseSize, props.complaint_count / 3));

                const markerGraphic = new window.ArcGISGraphic({
                    geometry: {
                        type: "point",
                        longitude: coords[0],
                        latitude: coords[1]
                    },
                    symbol: {
                        type: "simple-marker",
                        color: color,
                        outline: {
                            color: outlineColor,
                            width: 3
                        },
                        size: size
                    },
                    attributes: props,
                    popupTemplate: {
                        title: "<b>{borough}</b>",
                        content: `
                            <div style="padding: 10px;">
                                <p><b>üìä Complaints:</b> {complaint_count}</p>
                                <p><b>‚ö†Ô∏è Risk Score:</b> {risk_score}/100</p>
                                <p><b>üéØ Risk Level:</b> {risk_level}</p>
                            </div>
                        `
                    }
                });

                heatmapGraphicsLayer.add(markerGraphic);

                const labelGraphic = new window.ArcGISGraphic({
                    geometry: {
                        type: "point",
                        longitude: coords[0],
                        latitude: coords[1]
                    },
                    symbol: {
                        type: "text",
                        color: "white",
                        haloColor: [0, 0, 0, 0.9],
                        haloSize: "2px",
                        text: `${props.borough}\n${props.complaint_count}`,
                        font: {
                            size: 11,
                            family: "Arial, sans-serif",
                            weight: "bold"
                        }
                    }
                });

                heatmapLabelsLayer.add(labelGraphic);
            });
            
            console.log("‚úÖ Added", heatmapGraphicsLayer.graphics.length, "markers to map");
        }

        // Load borough statistics
        async function loadBoroughStats() {
            try {
                const response = await fetch('/api/heatmap/boroughs');
                const data = await response.json();

                if (data.ok && data.boroughs) {
                    const container = document.getElementById('boroughStatsContainer');
                    container.innerHTML = data.boroughs.map(borough => `
                        <div class="borough-card" onclick="zoomToBorough('${borough.name}', ${borough.lat}, ${borough.lng})">
                            <div class="borough-header">
                                <span class="borough-name">${borough.name}</span>
                                <span class="risk-badge ${borough.risk_level.toLowerCase()}">${borough.risk_level}</span>
                            </div>
                            <div class="borough-complaints">${borough.complaint_count} complaints</div>
                            <div class="risk-bar-container">
                                <div class="risk-bar" style="width: ${borough.risk_score}%; background: ${
                                    borough.risk_level === 'High' ? 'linear-gradient(90deg, #ef4444, #dc2626)' : 
                                    borough.risk_level === 'Medium' ? 'linear-gradient(90deg, #fbbf24, #f59e0b)' : 
                                    'linear-gradient(90deg, #4ade80, #22c55e)'
                                };"></div>
                            </div>
                        </div>
                    `).join('');

                    const totalComplaints = data.boroughs.reduce((sum, b) => sum + b.complaint_count, 0);
                    const highestRisk = data.boroughs.reduce((a, b) => a.risk_score > b.risk_score ? a : b);
                    const lowestRisk = data.boroughs.reduce((a, b) => a.risk_score < b.risk_score ? a : b);

                    document.getElementById('summaryTotalComplaints').textContent = totalComplaints.toLocaleString();
                    document.getElementById('summaryHighestRisk').textContent = highestRisk.name;
                    document.getElementById('summaryLowestRisk').textContent = lowestRisk.name;
                }
            } catch (error) {
                console.error('Failed to load borough stats:', error);
            }
        }

        function updateHeatmapSummary(summary) {
            if (summary.total_complaints !== undefined) {
                document.getElementById('summaryTotalComplaints').textContent = summary.total_complaints.toLocaleString();
            }
        }

        function zoomToBorough(name, lat, lng) {
            if (heatmapView) {
                heatmapView.goTo({
                    center: [lng, lat],
                    zoom: 12
                }, { duration: 1000, easing: "ease-in-out" });
            }

            document.querySelectorAll('.borough-card').forEach(card => {
                card.classList.remove('selected');
                if (card.textContent.includes(name)) {
                    card.classList.add('selected');
                }
            });

            loadBoroughAnalysis(name);
        }

        async function loadBoroughAnalysis(borough) {
            const insightsDiv = document.getElementById('heatmapAIInsights');
            const textDiv = document.getElementById('heatmapAIText');
            
            insightsDiv.classList.add('active');
            textDiv.innerHTML = '<span style="color: var(--light-300);">Loading AI analysis...</span>';

            try {
                const response = await fetch('/api/heatmap/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: `Analyze restaurant risks in ${borough}`,
                        borough: borough 
                    })
                });

                const data = await response.json();
                
                if (data.ok && data.analysis) {
                    let analysis = data.analysis;
                    if (analysis.length > 350) {
                        analysis = analysis.substring(0, 350) + '...';
                    }
                    textDiv.textContent = analysis;
                } else {
                    textDiv.textContent = 'Unable to load analysis for this borough.';
                }
            } catch (error) {
                console.error('Failed to load analysis:', error);
                textDiv.textContent = 'Error loading AI analysis.';
            }
        }

        applyHeatmapFiltersBtn.addEventListener('click', () => {
            const borough = heatmapBoroughFilter.value;
            loadHeatmapData(borough);
            
            if (borough && heatmapView) {
                const coords = {
                    'Manhattan': [-73.9712, 40.7831],
                    'Brooklyn': [-73.9442, 40.6782],
                    'Queens': [-73.7949, 40.7282],
                    'Bronx': [-73.8648, 40.8448],
                    'Staten Island': [-74.1502, 40.5795]
                };
                if (coords[borough]) {
                    heatmapView.goTo({
                        center: coords[borough],
                        zoom: 12
                    }, { duration: 800 });
                }
            }
        });

        resetHeatmapFiltersBtn.addEventListener('click', () => {
            heatmapBoroughFilter.value = '';
            loadHeatmapData();
            if (heatmapView) {
                heatmapView.goTo({
                    center: [-74.0060, 40.7128],
                    zoom: 10
                }, { duration: 800 });
            }
            document.querySelectorAll('.borough-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('heatmapAIInsights').classList.remove('active');
        });

        // Initialize
        updateSidebarStats();
        loadAgentStatus();
        setInterval(loadAgentStatus, 10000);
    </script>
</body>
</html>